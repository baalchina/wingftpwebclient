<%
include("language.html")

local plugin_dir = c_GetAppPath().."/webclient/plugins"

for isdir,plugin in c_GetFileDir(plugin_dir) do
	if isdir == true and c_FileExist(plugin_dir.."/"..plugin.."/setting.html") then
		include("plugins/"..plugin.."/setting.html")
	end
end

%><noscript><center><H2><%=LANG["error_nojavascript"]%></H2></center></noscript>
<%
if _SESSION["username"] ~= nil and _SESSION["currentpath"] ~= nil then

local enable_changepass = c_CanChangePass(_SESSION["username"])
local enable_sendmessage = c_CanSendMessage()
%>
<html>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="cache-control" content="no-cache, must-revalidate" />
<link rel="Shortcut Icon" href="images/logo.ico" type="image/x-icon">
<link href="css/style.css" rel="stylesheet" type="text/css" />
<head>
<title>
Wing FTP Server for nau
<%
local nType = c_GetLicenseInfo()
if nType >= 5 then
	print("(UNREGISTERED)")
end
%>
</title>
</head>
<script language="javascript" src="include/checkflash.js"></script>
<script language="javascript" src="include/common.js"></script>
<script language="javascript">
isIphone = navigator.userAgent.toLowerCase().indexOf('iphone')==-1? 0:1;
isIpod = navigator.userAgent.toLowerCase().indexOf('ipod')==-1? 0:1;
if(isIphone || isIpod)
	location = 'main_m.html';

var _TIMER_UPLOADING = null;
var _TIMER_PPT = null;
var _TIMER_KEEPLIVE = null;
var EXPTag = "session expired";
var ppt_showing = false;
var ppt_timervalue = 5000;
var ppt_startppt = "<%=LANG['button_startppt']%>";
var ppt_stopppt = "<%=LANG['button_stopppt']%>";
var viewmode = false;
var row_filenum = 5;
var now_dir = "/";
var now_image = "";
var file_num = 0;
var dir_num = 0;
var total_num = 0;
var thumb_num = 0;
var total_size = 0;
var selectedRow = null;
var lastObj = null;
var start_time = 0;
var uploading = false;
var upload_file = "";
var upload_filename = "";
var imageGroup = new Array();
var imgMap = null;
var imgMap2 = null;
var imglist = null;
var imglist2 = null;
var download_url = "";
var videolist_show = false;
var last_uploadsize = 0;
var last_lefttime = -1;
var auto_overwrite = false;
var appletSavePath = "none";
var bigfilesize = 0;
var moreaction_show = false;
var txt_filename = "";
var last_field = -1;
var reverse_sort = false;


var charArray = ['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
function generateRandom() 
{
    var result = "";
	for(var i = 0; i < 8; i++) 
	{
		var index = 0;
		index = Math.ceil(Math.random()*(charArray.length-1) );
		result += charArray[index];
	}
	$("downloadpass").value = result;
}

function clear_imageGroup() 
{
	imageGroup = null;
	imageGroup = new Array();
}

function ajaxResponse()
{
	if (xmlhttp.readyState == 4)
	{
		ajaxlock = false;
		if (xmlhttp.status == 200)
		{
			try
			{
				switch(page)
				{
					case 'chdir':		chdir();break;
					case 'mkdir':		mkdir();break;
					case 'rmdir':		rmdir();break;
					case 'rename':		rename();break;
					case 'paste':		paste();break;
					case 'dir':			showlist();break;
					case 'ed2kurl':		ed2kurl();break;
					case 'changepass':	changepass();break;
					case 'checkdownload':	checkdownload_Result();break;
					case 'zip':			zip();break;
					case 'unzip':		unzip();break;
					case 'rmdirfile':	rmdirfile();break;
					case 'mkfile':		mkfile();break;
					case 'weblink':		weblink();break;
					case 'weblink_update':		weblink_update_result();break;
				}
			}
			catch(e)
			{
				if(page != "dir")
					alert("<%=LANG['error_ajax']%>");
			}
			finally
			{
				if(page != "dir")
				{
					$("waitingdiv").style.display = "none";
					$("waitingdiv2").style.display = "none";
				}
			}
		}
		else
		{
			$("waitingdiv").style.display = "none";
			$("waitingdiv2").style.display = "none";
			if(page != "")
				alert("<%=LANG['error_ajax']%>");

		}
	}
}

function uploadError()
{
	if(uploading == true)
		alert("<%=LANG['error_upload']%>");
	uploadEnd();
}

function uploadRefresh()
{
	var ajaxObject = false;
	ajaxObject = isIE ? new ActiveXObject('Microsoft.XMLHTTP'):new XMLHttpRequest();

	if(ajaxObject) 
	{
		ajaxObject.open("GET","uploadstat.html?r="+Math.random() );
		ajaxObject.onreadystatechange = function()
		{
			if (ajaxObject.readyState == 4) 
			{
				if(ajaxObject.status == 200)
				{
					if(uploading == true)
					{
						var result = trim(ajaxObject.responseText);
						if(result == "-1")
						{
							if((upload_filename != "" && upload_filename == upload_file) || upload_filename == "")
							{
								if(last_lefttime < 0 || last_lefttime > 4)
								{
									setTimeout("uploadError()",1000);
								}
								else
								{
									uploadEnd_ok();
									ajaxRequest("dir","");
								}
							}
							else
							{
								uploadEnd_ok();
								ajaxRequest("dir","");
							}
						}
						else if(result == "-2")
						{
							alert("<%=LANG['error_upload']%>");
							uploadEnd();
						}
						else if(result == "-3")
						{
							alert("<%=LANG['error_upload3']%>");
							uploadEnd();
							ajaxRequest("dir",'r='+Math.random());
						}
						else if(result == "-4")
						{
							alert("<%=LANG['error_upload4']%>");
							uploadEnd();
							ajaxRequest("dir",'r='+Math.random());
						}
						else if(result == "0")
						{
							alert("<%=LANG['session_expire']%>");
							uploadEnd();
						}
						else if(result != "")
						{
							try
							{
								result = result.split("/");
								var d = new Date();
								var end_time = d.getTime();
								if(parseInt(result[0]) < last_uploadsize)
								{
									result[0] = last_uploadsize;
								}
								else
								{
									last_uploadsize = result[0];
								}
								var speed = fileSize(1000*result[0]/(end_time-start_time));
								var leftsize = (result[1]-result[0]) > 0 ? (result[1]-result[0]) : 0;
								var lefttime = leftsize / (1000*result[0]/(end_time-start_time));
								var scale = round((result[0] / result[1])*100 , 2);
								upload_filename = result[2];
								last_lefttime = parseInt(lefttime);

								if(upload_filename != "" && upload_filename != upload_file)
								{
									uploadError();
									return;
								}

								$("uploadingDiv").innerHTML = "<%=LANG['uploadstat_filename']%><span title='"+upload_filename+"'>"+upload_filename.substr(0,32)+(upload_filename.length > 32 ? "...":"")+"</span><br><%=LANG['uploadstat_totalsize']%>"+fileSize(result[1])+"<br><%=LANG['uploadstat_nowsize']%>"+fileSize(result[0])+"<br><%=LANG['uploadstat_speed']%>"+speed+"/s";
								$("uploadingDiv").innerHTML += "<br><%=LANG['uploadstat_sizeleft']%>"+fileSize(leftsize)+", <%=LANG['uploadstat_timeleft']%>"+formatTime(lefttime);
								$("uploadingDiv").innerHTML += "<br><div class='progress_border'><div class='progress_bar' style='background-position:"+(100-scale)+"% 0px'>"+scale+"%</div></div>";
							}
							catch(e){}
						}
					}

				}
				delete ajaxObject;
				ajaxObject = null;
			}
		}
		ajaxObject.send("");
	}
}

function sess_expire()
{
	alert("<%=LANG['session_expire']%>");
	window.location = "logout.html";
}

function chdir()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	/*
	if(result != "<%=RESULT_STR[1]%>")
		alert(result);
	else
		ajaxRequest("dir",'r='+Math.random());
	*/
	ajaxRequest("dir",'r='+Math.random());
}

function mkdir()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	alert(result);	
	top.closewindow();
	ajaxRequest("dir",'r='+Math.random());
}

function rmdir()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	alert(result);	
	ajaxRequest("dir",'r='+Math.random());
}

function rename()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	alert(result);	
	top.closewindow();
	ajaxRequest("dir",'r='+Math.random());
}

function paste()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	alert(result);	
	$("pasteitem").style.display = "none";
	$("pasteitem2").style.display = "none";
	$("pasteitem3").style.display = "none";
	ajaxRequest("dir",'r='+Math.random());
}


function showlist()
{
	clear("listview_div");
	clear("videolist_div");
	clear_imageGroup();
	$("waitingdiv").style.display = "";
	var nowquota = 0;
	var maxquota = 0;

	selectedRow = null;
	file_num = 0;
	dir_num = 0;
	total_num = 0;
	total_size = 0;
	hitcount = 0;

	try
	{
		var result = trim(xmlhttp.responseText);
		if(result == EXPTag)
		{
			sess_expire();
			return;
		}

		var xmldoc = xmlhttp.responseXML;
		var row = xmldoc.getElementsByTagName("rowdata");
		var rownum = row.length;

		now_dir = decodeURIComponent(xmlFieldValue(xmldoc,"nowdir"));
		nowquota = xmlFieldValue(xmldoc,"nowquota");
		maxquota = xmlFieldValue(xmldoc,"maxquota");

		var headcell = $("listhead").rows[0].cells;
		var htmltext = "<table id='listtable' width='100%' border='0' cellpadding='0' cellspacing='0' style='table-layout:fixed;'><thead><tr height='0'><td width='"+headcell[0].width+"'></td><td width='"+headcell[1].width+"'></td><td width='"+headcell[2].width+"'></td><td width='"+headcell[3].width+"'></td><td></td></tr></thead><tbody id='maintable'>";

		for(var i=0; i < rownum; i++)
		{
			try
			{
				var myrow = row[i];
				f_img = "";
				f_perm = xmlFieldValue(myrow,"perm");
				f_size = xmlFieldValue(myrow,"size");
				f_group = xmlFieldValue(myrow,"group");
				f_date = xmlFieldValue(myrow,"date");
				f_name = decodeURIComponent(xmlFieldValue(myrow,"name"));
				f_dir = xmlFieldValue(myrow,"dir");
				f_md5 = xmlFieldValue(myrow,"md5");
				filesize = f_size;

				total_size += parseInt(f_size);

				if(f_dir == 1)
				{
					f_dir = "<%=LANG['list_directory']%>";
					if(isIE)
						f_img = "<img _src='icons/directory.gif'> ";
					else
						f_img = "<img src='icons/directory.gif'> ";
					dir_num++;
				}
				else
				{
					var file_ext = getExtention(f_name);
					var file_name = urlEncodeSpecial(f_name);
					f_dir = "&nbsp;" + file_ext + " <%=LANG['list_filetype']%>";
					f_size = fileSize(f_size);
					if(isIE)
					{
						if(extIcons[file_ext] == true)
							f_img = "<img _src='icons/"+ file_ext +".gif'> ";
						else
							f_img = "<img _src='icons/default.gif'> ";
					}
					else
					{
						if(extIcons[file_ext] == true)
							f_img = "<img src='icons/"+ file_ext +".gif'> ";
						else
							f_img = "<img src='icons/default.gif'> ";
					}
					if(file_ext == "gif" || file_ext == "png" || file_ext == "jpg" || file_ext == "jpeg" || file_ext == "bmp")
						imageGroup.push(file_name);

					file_num++;

					var videoitem = "";
					if(file_ext == "mid" || file_ext == "wav" || file_ext == "mp3" || file_ext == "wma" || file_ext == "wmv" 
						|| file_ext == "asf" || file_ext == "avi" || file_ext == "mpg" || file_ext == "mpeg")
					{
						videoitem = "<li><a href='#' onclick='show_video(\""+file_name+"&UID=<%=_SESSION_ID%>\",2,\""+f_name.replace(/\'/g,"%27")+"\");'>"+file_num+". "+f_name+"</a></li>";
					}
					else if(file_ext == "rm" || file_ext == "ra" || file_ext == "rmvb")
					{
						videoitem = "<li><a href='#' onclick='show_video(\""+file_name+"&UID=<%=_SESSION_ID%>\",1,\""+f_name.replace(/\'/g,"%27")+"\");'>"+file_num+". "+f_name+"</a></li>";
					}
					else if(file_ext == "swf")
					{
						videoitem = "<li><a href='#' onclick='show_video(\""+file_name+"&UID=<%=_SESSION_ID%>\",0,\""+f_name.replace(/\'/g,"%27")+"\");'>"+file_num+". "+f_name+"</a></li>";
					}
					write("videolist_div",videoitem);
				}


				if(isIE)
					htmltext += "<tr class='listtr01' oncontextmenu='do_list_click(this,-1,1);' onclick='do_list_click(this,-1);' ondblclick='do_list_dblclick(this,-1);' tabIndex='-1'>";
				else
					htmltext += "<tr class='listtr01' oncontextmenu='do_list_click(this,-1,1);' onclick='do_list_click(this,-1);' tabIndex='-1'>";

				htmltext += "<td style='padding:3px;' id='tr_"+i+"' md5='"+f_md5+"' fsize='"+filesize+"' name=\""+htmlencode(f_name)+"\"><input type='checkbox' id='cid_"+i+"' cid='"+i+"' flag='list'> "+f_img+htmlencode(f_name)+"</td>";
				htmltext += "<td>"+f_size+"</td>";
				htmltext += "<td>"+f_dir+"</td>";
				htmltext += "<td>"+f_date+"</td>";
				htmltext += "<td></td></tr>";
				
				total_num++;
				lastsortcol = -1;
				
			}
			catch(e){}
		}

		htmltext += "</tbody></table>";
		write("listview_div",htmltext);
		$("listview_div").scrollTop = 0;
	}
	catch(e)
	{
		$("waitingdiv").style.display = "none";
		$("waitingdiv2").style.display = "none";
		var result = trim(xmlhttp.responseText);
		if(result == EXPTag)
		{
			sess_expire();
			return;
		}
	}

	$("statbar").innerHTML = "<%=LANG['headbar_txt1']%><span title='"+htmlencode(now_dir)+"'>"+htmlencode(now_dir.substr(0,100))+(now_dir.length > 100 ? "...":"")+"</span>&nbsp;&nbsp;&nbsp;<%=LANG['headbar_txt2']%>"+file_num+"<%=LANG['headbar_txt3']%>"+dir_num+"<%=LANG['headbar_txt4']%>"+fileSize(total_size);

	if(maxquota != 0)
	{
		if(parseInt(nowquota) > parseInt(maxquota))
		{
			nowquota = maxquota;
		}
		var scale = round((nowquota / maxquota)*100 , 2);
		var strUsedQuota = "<%=LANG['str_user_quota']%>: "+fileSize(nowquota)+" / "+fileSize(maxquota);
		$("diskquota").innerHTML = "<div class='progress_border2'><div class='progress_bar2' style='background-position:"+(100-scale)+"% 0px'>"+scale+"%</div></div><div style='font-size:9px;color: #444;' title='"+strUsedQuota+"'>"+strUsedQuota+"</div>";
	}

	if(total_num > 0)
	{
		if(last_field == 0)
		{
			sortTable(null,'listtable', 0, 'filename');

			if(reverse_sort == true)
				sortTable(null,'listtable', 0, 'filename');
		}
		else if(last_field == 1)
		{
			sortTable(null,'listtable', 1, 'size');

			if(reverse_sort == true)
				sortTable(null,'listtable', 1, 'size');
		}
		else if(last_field == 2)
		{
			sortTable(null,'listtable', 2);

			if(reverse_sort == true)
				sortTable(null,'listtable', 2);
		}
		else if(last_field == 3)
		{
			sortTable(null,'listtable', 3);

			if(reverse_sort == true)
				sortTable(null,'listtable', 3);
		}
		else
		{
			sortTable(null, "listtable", 2);
		}
	}

	thumb_num = 0;
	if(viewmode == true) showthumb();


	imglist = $("listview_div").getElementsByTagName("img");
	imgMap = null;
	imgMap = new Object();
	for(var ii=0;ii<imglist.length;ii++)
	{
		var src = imglist[ii].getAttribute('_src');
		if(src)
		{
			if(imgMap[src])
			{
				imgMap[src].push(ii);
			}
			else
			{
				imgMap[src] = new Array();
				imgMap[src].push(ii);
			}
		}
	}
	for(var imgurl in imgMap)
	{
		var imgindex = imgMap[imgurl][0];
		imglist[imgindex].onload = function(){setImageList();}
		imglist[imgindex].src = imgurl;
	}

	viewmode = getCookie("viewmode");
	change_viewmode(viewmode);
	thumbimage_req = 0;
	thumbimage_rsp = 0;
	$("waitingdiv").style.display = "none";
	$("waitingdiv2").style.display = "none";

	if(lastArrow != null)
		lastArrow.style.backgroundImage="";
}


function setImageList()
{
	var imgurl = event.srcElement.src;
	imgurl = "icons/"+imgurl.substr(imgurl.lastIndexOf("/")+1).toLowerCase();
	if(imgMap[imgurl] && imgMap[imgurl].length >= 1)
	{
		for(var jj=1;jj<imgMap[imgurl].length;jj++)
		{
			var imgindex = imgMap[imgurl][jj];
			imglist[imgindex].src = imgurl;
		}
	}
}


function showthumb()
{
	if(isIE)
		RemoveRow("thumbtable");
	else
		clear("thumbtable");

	if(total_num <= 0)
	{
		$("waitingdiv").style.display = "none";
		$("waitingdiv2").style.display = "none";
		return;
	}
	
	var screen_width = getBrowerWidth() > 1024 ? getBrowerWidth():1024;
	row_filenum = parseInt(screen_width / 200);
	var cell_width = parseInt(100/row_filenum)+"%";
	var row = $("listtable").tBodies[0].rows;
	var tr = null;

	for (var i=0; i < row.length; i++)
	{
		try
		{
			f_img = "";
			f_name = row[i].cells[0].getAttribute("name");
			f_filename = htmldecode(f_name);
			f_md5 = row[i].cells[0].getAttribute("md5");
			f_size = row[i].cells[1].innerHTML;
			f_isdir = row[i].cells[2].innerHTML;
			f_date = row[i].cells[3].innerHTML;
			f_ext = getExtention(f_filename);

			var ischecked = "";
			if($("cid_"+i).checked) ischecked = "checked";

			if(f_md5 != "" && (f_ext == "gif" || f_ext == "png" || f_ext == "jpg" || f_ext == "jpeg") )
			{
				f_img = "<div class='rect'><table style='width:100%;height:100%;'><tr><td class='boxalign'><input type='checkbox' "+ischecked+" ccid='"+i+"' onclick='clickCheckbox(this);'></td><td id='"+f_md5+"' class='picalign'><img src='thumbimg/"+f_md5+".jpg?r=1' onerror='makethumb_req(\""+f_md5+"\",\""+htmlencode(f_filename)+"\");'></td></tr></table></div>";
			}
			else
			{
				if(isIE)
				{
					if(f_isdir == "<%=LANG['list_directory']%>")
					{
						f_icon = "<img _src='icons/directory_b.gif'>";
					}
					else
					{
						if(extIcons[f_ext] == true)
							f_icon = "<img _src='icons/"+ f_ext +"_b.gif'>";
						else
							f_icon = "<img _src='icons/default_b.gif'>";
					}
				}
				else
				{
					if(f_isdir == "<%=LANG['list_directory']%>")
					{
						f_icon = "<img src='icons/directory_b.gif'>";
					}
					else
					{
						if(extIcons[f_ext] == true)
							f_icon = "<img src='icons/"+ f_ext +"_b.gif'>";
						else
							f_icon = "<img src='icons/default_b.gif'>";
					}
				}
				f_img = "<div class='rect'><table style='width:100%;height:100%;'><tr><td class='boxalign'><input type='checkbox' "+ischecked+" ccid='"+i+"' onclick='clickCheckbox(this);'></td><td class='iconalign'>" + f_icon + "</td></tr></table></div>";
			}

			if(i % row_filenum == 0)
			{
				tr = document.createElement("tr");
				tr.setAttribute('vAlign','top');
				$("thumbtable").appendChild(tr); 
			}
			var tmpcell = document.createElement("td"); 
			if(isIE)
			{
				tmpcell.onclick = function()
				{
					do_list_click(this,-2);
				}
				tmpcell.oncontextmenu = function()
				{
					do_list_click(this,-2,1);
				}
				tmpcell.ondblclick = function()
				{
					do_list_dblclick(this,-2);
				}
			}
			else
			{
				tmpcell.setAttribute('onclick','do_list_click(this,'+i+');');
				tmpcell.setAttribute('oncontextmenu','do_list_click(this,'+i+',1);');
			}
			tmpcell.setAttribute('width',cell_width);
			tmpcell.setAttribute('class','listtr03');
			tmpcell.setAttribute('className','listtr03');
			tmpcell.setAttribute('name',f_name);
			tmpcell.setAttribute('tabIndex',-1);
			tmpcell.setAttribute('fsize',row[i].cells[0].getAttribute("fsize"));
			tmpcell.setAttribute('id',"td_"+i);
			tmpcell.setAttribute('title','<%=LANG["thread_name"]%>:'+f_filename+'\r\n<%=LANG["thread_size"]%>:'+f_size+'\r\n<%=LANG["thread_modify"]%>:'+f_date);
			tmpcell.innerHTML = f_img+f_filename.substr(0,20)+(f_filename.length > 20 ? "...":"")
			tr.appendChild(tmpcell); 
			thumb_num++;
			
		}
		catch(e){}
	}
	if(row.length > 0 && row.length < row_filenum)
	{
		var space_num = row_filenum - row.length; 
		for(j=0;j<space_num;j++)
		{
			var tmpcell = document.createElement("td"); 
			tmpcell.setAttribute('width','20%');
			tmpcell.setAttribute('height','100');
			tr.appendChild(tmpcell); 
		}
	}
	$("thumbview_div").scrollTop = 0;

	imglist2 = $("thumbview_div").getElementsByTagName("img");
	imgMap2 = null;
	imgMap2 = new Object();
	for(var ii=0;ii<imglist2.length;ii++)
	{
		var src = imglist2[ii].getAttribute('_src');
		if(src)
		{
			if(imgMap2[src])
			{
				imgMap2[src].push(ii);
			}
			else
			{
				imgMap2[src] = new Array();
				imgMap2[src].push(ii);
			}
		}
	}
	for(var imgurl2 in imgMap2)
	{
		var imgindex = imgMap2[imgurl2][0];
		imglist2[imgindex].onload = function(){setImageThumb();}
		imglist2[imgindex].src = imgurl2;
	}

	$("waitingdiv").style.display = "none";
	$("waitingdiv2").style.display = "none";

}

function setImageThumb()
{
	var imgurl2 = event.srcElement.src;
	imgurl2 = "icons/"+imgurl2.substr(imgurl2.lastIndexOf("/")+1).toLowerCase();
	if(imgMap2[imgurl2] && imgMap2[imgurl2].length >= 1)
	{
		for(var jj=1;jj<imgMap2[imgurl2].length;jj++)
		{
			var imgindex2 = imgMap2[imgurl2][jj];
			imglist2[imgindex2].src = imgurl2;
		}
	}
}

function do_list_click(obj, cellindex, rightmouse)
{
	var evt;
	try
	{
		evt = getEvent();
		var element = evt.srcElement || evt.target;
		if(element.tagName == "INPUT")
		{
			return;
		}
	}
	catch(e){}

	var row_index = 0;

	if(cellindex >= 0)
		row_index = cellindex;
	else if(cellindex == -2)
		row_index = row_filenum*obj.parentNode.rowIndex+obj.cellIndex;
	else
		row_index = obj.rowIndex-1;

	$("menu_div").style.visibility = "hidden";
	$("menu_div2").style.visibility = "hidden";

	if(rightmouse == 1)
	{
		var evt = getEvent();
		moreaction_show = false;
		$("action_div").style.visibility = "hidden";
		$("menu_div2").style.visibility = "hidden";
		$("menu_div").style.visibility = ""; 
		$("menu_div").style.top = evt.clientY - 150; 
		$("menu_div").style.left = evt.clientX; 
	}

	if(selectedRow != $("maintable").rows[row_index])
	{
		if(cellindex == -1)
		{
			if(lastObj != null)
				lastObj.className = "listtr01";
			selectedRow = $("maintable").rows[row_index];
			obj.className = "listtr02";
			lastObj = obj;
		}
		else
		{
			if(lastObj != null)
				lastObj.className = "listtr03";
			selectedRow = $("maintable").rows[row_index];
			obj.className = "listtr04";
			lastObj = obj;
		}

		try
		{
			if(selectedRow != null)
			{
				var f_name = htmldecode(selectedRow.cells[0].getAttribute("name"));
				var file_ext = getExtention(f_name);
				if(selectedRow.cells[2].innerHTML == "<%=LANG['list_directory']%>" || file_ext != "zip")
					$("unzipitem").style.display = "none";
				else
					$("unzipitem").style.display = "";
			}
		}
		catch(e){}
	}
	else
	{
		if(rightmouse == 1)
			return false;
		if(!isIE || isWindowsPhone || isARM)
		{
			if(evt.button == 0 || evt.button == 1 || evt.button == 2)
				openFileDirectory();
			else
				downloadFile_ext();
		}
	}

	return false;
}

function do_list_dblclick(obj,cellindex)
{
	var evt;
	try
	{
		evt = getEvent();
		var element = evt.srcElement || evt.target;
		if(element.tagName == "INPUT")
		{
			return;
		}
	}
	catch(e){}

	var row_index = 0;
	if(cellindex >= 0)
		row_index = cellindex;
	else if(cellindex == -2)
		row_index = row_filenum*obj.parentNode.rowIndex+obj.cellIndex;
	else
		row_index = obj.rowIndex-1;
	selectedRow = $("maintable").rows[row_index];

	if(selectedRow.cells[2].innerHTML == "<%=LANG['list_directory']%>")
	{
		openDirectory();
	}
	else
	{
		if(evt.keyCode != 13)
			downloadFile();
		else
			downloadFile_ext();
	}
	return false;
}

function openFileDirectory()
{
	if(selectedRow.cells[2].innerHTML == "<%=LANG['list_directory']%>")
	{
		openDirectory();
	}
	else
	{
		downloadFile();
	}
}

function openDirectory()
{
	if(selectedRow == null)
	{
		alert("<%=LANG['error_nofile']%>");
		return;
	}
	var f_name = selectedRow.cells[0].getAttribute("name");
	var filename = urlEncode(htmldecode(f_name));
	ajaxRequest("chdir","dir="+filename);
}

function goUp()
{
	ajaxRequest("chdir","dir=..");
}

function goTo()
{
	showMessagebox("<%=LANG['goto_title']%>","<br><%=LANG['goto_path']%>: <input type='text' id='dirname' value='"+htmlencode(now_dir)+"' style='width:190px' tabindex='30'><br><br><br><button id='btn_submit' type='submit' onclick='goTo_submit();' tabindex='20'><span><em><%=LANG['create_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();' tabindex='21'><span><em><%=LANG['create_cancel']%></em></span></button>");
	$("dirname").focus();

	if(isIE)
	{
		$("btn_submit").onclick = function(){goTo_submit();};
		$("btn_cancel").onclick = function(){top.closewindow();};
	}
}

function goTo_submit()
{
	ajaxRequest("chdir","dir="+urlEncode(htmldecode($("dirname").value)));
	top.closewindow();
}

function goHome()
{
	ajaxRequest("chdir","dir=/");
}

function Refresh()
{
	ajaxRequest("dir",'r='+Math.random());
}

function selectTime()
{
	var strMyDate = "";
	var strMyTime = "";

	var timevalue = $("expiretime").value;
	if(timevalue != "")
	{
		var timeArray = timevalue.split(" ");
		strMyDate = timeArray[0];
		strMyTime = timeArray[1];
	}
	var frametag = new Date().getTime();
	showMessagebox("<%=LANG['str_selecttime']%>","<iframe src='select_time.html?mydate="+strMyDate+"&mytime="+strMyTime+"&seeds=" + Math.random() +"' width=280 height=320 border=0 frameborder=0 id='modify"+frametag+"'></iframe>",selectTime_callback,280,320);
}

function selectTime_callback(str)
{
	if(str != "" && str != null)
		$("expiretime").value = str;
}

function formatLimitNumber(numbervalue)
{
	$("downloadlimit").value = numbervalue.replace(/\D/g,'');
}

function clearTime()
{
	$("expiretime").value = "";
}

function showDownloadUrl()
{
	if(selectedRow == null)
	{
		alert("<%=LANG['error_edit']%>");
		return;
	}

	if(selectedRow.cells[2].innerHTML != "<%=LANG['list_directory']%>")
	{
		var f_name = selectedRow.cells[0].getAttribute("name");

		showMessagebox("<%=LANG['weblink_title']%>","<table width='100%' border='0' cellpadding='2' cellspacing='3'><tr><td style='padding-left:10px;padding-top:15px;' colspan=2><input type='checkbox' id='enable_weblink' onclick='clickWeblink();' tabindex='34'> <b><%=LANG['enable_weblink']%></b></td></tr><tr><td style='padding-left:10px;' colspan=2><textarea id='weblink_text' style='width:480px;height:85px' disabled tabindex='35'> </textarea></td></tr><tr><td style='padding-left:10px;width:140px;'><%=LANG['str_expire_on']%>:</td><td><input id='expiretime' type='text' value='' disabled onclick='selectTime();' style='width:150px;' readonly tabindex='36'> <span><em><img src='images/clean.gif' align='absmiddle' id='btn_clear_date' onclick='clearTime();' title='Clean' style='border: 1px solid #666; padding:0px; cursor:pointer;' tabindex='37'>&nbsp;</em></span> <%=LANG['str_optional']%></td></tr><tr><td style='padding-left:10px; width:110px;'><%=LANG['str_download_limit']%>:</td><td><input id='downloadlimit' type='text' maxlength='6' value='' disabled onkeyup='formatLimitNumber(this.value);' onafterpaste='formatLimitNumber(this.value);' style='width:150px;' tabindex='38'> <%=LANG['str_optional']%></td></tr><tr><td style='padding-left:10px; width:110px;'><%=LANG['password']%></td><td><input id='downloadpass' type='text' maxlength='30' value='' disabled style='width:150px;' tabindex='39'> <button onclick='generateRandom();' title='<%=LANG['str_generate_pass']%>'><span style='vertical-align:middle;'><em><img src='images/password.gif' align='absmiddle'>&nbsp;</em></span></button> <%=LANG['str_optional']%></td></tr><tr><td style='padding-left:6px;'><input type='checkbox' id='enable_sendmail' tabindex='40' onclick='enableSendMail();' value='1' disabled> <%=LANG['str_sendmail']%>:</td><td><input id='mail_address' type='text' maxlength='100' tabindex='41' onblur=\"if(this.value=='') this.value='<%=LANG['str_multiple_emails']%>'\" onfocus=\"if(this.value =='<%=LANG['str_multiple_emails']%>' ) this.value=''\" value='<%=LANG['str_multiple_emails']%>' style='width:320px;color:#898989;' disabled></td></tr><tr><td style='padding-left:30px;'><%=LANG['str_senderemail']%>:</td><td><input id='sender_mail_address' type='text' maxlength='80' tabindex='42' style='width:180px; color:#898989;' disabled> <%=LANG['str_optional']%></td></tr><tr><td style='padding-left:30px;'><%=LANG['str_field_message']%> <%=LANG['str_optional']%>:</td><td><textarea id='mail_message' style='width:320px;height:35px' maxlength='300' tabindex='43' disabled></textarea> </td></tr><tr align='center'><td height='50' colspan=2><button id='btn_submit' type='submit' onclick='update_weblink();' tabindex='44'><span><em><%=LANG['create_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();' tabindex='45'><span><em><%=LANG['create_cancel']%></em></span></button></td></tr></table>",null,530,400);

		$("enable_weblink").focus();

		ajaxRequest("weblink","operation=get&filename="+urlEncode(f_name) );

		if(isIE)
		{
			$("enable_weblink").onclick = function(){clickWeblink();};
			$("expiretime").onclick = function(){selectTime();};
			$("btn_clear_date").onclick = function(){clearTime();};
			$("btn_submit").onclick = function(){update_weblink();};
			$("btn_cancel").onclick = function(){top.closewindow();};
		}
	}
	else
	{
		alert("<%=LANG['error_edit']%>");
	}
}

function enableSendMail()
{
	if($("enable_sendmail").checked)
	{
	<% if enable_sendmessage == true then %>
		$("mail_address").disabled = false;
		$("sender_mail_address").disabled = false;
		$("mail_message").disabled = false;
	<% else %>
		alert("<%=LANG['str_no_smtpconfig']%>");
	<% end %>
	}
	else
	{
		$("mail_address").disabled = true;
		$("sender_mail_address").disabled = true;
		$("mail_message").disabled = true;
	}
}

function update_weblink()
{
	var f_name = selectedRow.cells[0].getAttribute("name");
	var expiretime = htmldecode($("expiretime").value);
	var downloadlimit = htmldecode($("downloadlimit").value);
	var downloadpass = htmldecode($("downloadpass").value);
	var sendmail = ($("enable_sendmail").checked ? "yes":"");

	var mailaddress = htmldecode($("mail_address").value);
	var sender_mailaddress = htmldecode($("sender_mail_address").value);
	var mail_message = htmldecode($("mail_message").value);
	var localaddress = location.href.replace(/\#/g,"");
	var hostname = location.hostname;

	if($("enable_weblink").checked)
	{
		ajaxRequest("weblink_update","filename="+urlEncode(f_name)+"&sendmail="+sendmail+"&mailaddress="+urlEncode(mailaddress)+"&sender_mailaddress="+urlEncode(sender_mailaddress)+"&mail_message="+urlEncode(mail_message)+"&hostname="+urlEncode(hostname)+"&localaddress="+urlEncode(localaddress)+"&expiretime="+urlEncode(expiretime)+"&downloadlimit="+urlEncode(downloadlimit)+"&downloadpass="+urlEncode(downloadpass)+"&r="+Math.random());
	}
	top.closewindow();
}

function weblink_update_result()
{
	var result = xmlhttp.responseText;
	if(trim(result) == "Error: sending email")
	{
		alert("<%=LANG['send_email_error']%>");
	}
	else if(trim(result) == "Error: no permission")
	{
		alert("<%=LANG['make_weblink_error']%>");
	}
	else if(trim(result) == "operation successful")
	{
		alert("<%=RESULT_STR[1]%>");
	}
}

function clickWeblink()
{
	if($("enable_weblink").checked)
	{
		var f_name = selectedRow.cells[0].getAttribute("name");
		ajaxRequest("weblink","operation=add&filename="+urlEncode(f_name) );
	}
	else
	{
		var f_name = selectedRow.cells[0].getAttribute("name");
		ajaxRequest("weblink","operation=del&filename="+urlEncode(f_name) );
	}
}

function weblink()
{
	var result = xmlhttp.responseText;
	try
	{
		if(trim(result) == "")
		{
		}
		else if(trim(result) == "noperm")
		{
			alert("<%=LANG['make_weblink_error']%>");

			$("enable_weblink").checked = false;
			$("weblink_text").value = "";
			$("weblink_text").disabled = true;
			$("expiretime").disabled = true;
			$("downloadlimit").disabled = true;
			$("downloadpass").disabled = true;
			$("enable_sendmail").disabled = true;
			$("mail_address").disabled = true;
			$("mail_message").disabled = true;
		}
		else if(trim(result) == "deleted")
		{
			$("enable_weblink").checked = false;
			$("weblink_text").value = "";
			$("weblink_text").disabled = true;
			$("expiretime").disabled = true;
			$("downloadlimit").disabled = true;
			$("downloadpass").disabled = true;
			$("enable_sendmail").disabled = true;
			$("mail_address").disabled = true;
			$("mail_message").disabled = true;
		}
		else
		{
			var f_name = selectedRow.cells[0].getAttribute("name");
			var filename = urlEncodeSpecial(f_name);

			$("enable_weblink").checked = true;
			$("weblink_text").disabled = false;
			$("expiretime").disabled = false;
			$("downloadlimit").disabled = false;
			$("downloadpass").disabled = false;
			$("enable_sendmail").disabled = false;
			//$("mail_address").disabled = false;

			var localaddress = location.href.replace(/\#/g,"");

			var strWebLink = trim(result);
			if(result.indexOf("\r\n") != -1)
			{
				var resultArray = result.split("\r\n");
				strWebLink = resultArray[0];
				if(resultArray[1] >= 0)
					$("downloadlimit").value = resultArray[1];
				else
					$("downloadlimit").value = "";

				if(resultArray[2] >= 0)
					$("expiretime").value = translateTime(resultArray[2]);
				else
					$("expiretime").value = "";

				if(resultArray[3] != null && resultArray[3] != "")
					$("downloadpass").value = resultArray[3];
				else
					$("downloadpass").value = "";

			}

			$("downloadlimit").style.color = "#000000";
			$("expiretime").style.color = "#000000";

			if($("downloadlimit").value == "0")
				$("downloadlimit").style.color = "#FF0000";

			if($("expiretime").value != "")
			{
				if(compareDate($("expiretime").value) == true)
					$("expiretime").style.color = "#FF0000";
			}
			$("weblink_text").value = localaddress + "?download&weblink="+strWebLink+"&realfilename="+filename;
		}
	}
	catch(e){}
}

function ed2kurl()
{
	var ed2k_url = xmlhttp.responseText;
	ed2k_url = ed2k_url.replace("\n","");
	try
	{
		if(trim(ed2k_url) == "")
		{
			alert("<%=LANG['error_ed2k']%>");
		}
		else
		{
			var f_name = selectedRow.cells[0].getAttribute("name");
			var filename = htmldecode(f_name);
			filename = urlEncodeSpecial(f_name);
			var localaddress = location.href.replace(/\#/g,"");
			var downloadURL = localaddress + "?download&filename="+filename+"&UID=<%=_SESSION_ID%>&nowpath="+urlEncodeSpecial(now_dir)+"&r="+Math.random();
			$("urlcontent").value = "ed2k://|file|"+f_name+"|"+ed2k_url+"|s="+downloadURL+"|/";
			$("urltitle").innerHTML = "<%=LANG['label_ed2kurl']%>";
			$("ed2kurl_btn").innerHTML = "<span><em><%=LANG['button_httpurl']%></em></span>";
			$("ed2kurl_btn").onclick = function()
			{
				$("urlcontent").value = downloadURL;
				$("urltitle").innerHTML = "<%=LANG['label_httpurl']%>";
				$("ed2kurl_btn").innerHTML = "<span><em><%=LANG['button_ed2kurl']%></em></span>";
				$("ed2kurl_btn").onclick = function()
				{
					ajaxRequest("ed2kurl","filename="+f_name);
				}
			}
		}
	}
	catch(e){}
}

function createFolder()
{
	showMessagebox("<%=LANG['create_title']%>","<br><%=LANG['create_filename']%>: <input type='text' id='newdirname' style='width:180px' maxlength='128' tabindex='30'><br><br><br><button id='btn_submit' type='submit' onclick='createFolder_submit()' tabindex='20'><span><em><%=LANG['create_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();' tabindex='21'><span><em><%=LANG['create_cancel']%></em></span></button>");
	$("newdirname").focus();

	if(isIE)
	{
		$("btn_submit").onclick = function(){createFolder_submit();};
		$("btn_cancel").onclick = function(){top.closewindow();};
	}
}

function createFolder_submit()
{
	var newname = htmldecode($("newdirname").value);
	if(newname.search(/[\\\/\<\>\:\?\"\|\*]/i) != -1)
	{
		alert("<%=LANG['error_bad_filename']%>");
		return false;
	}
	else if(newname == "")
	{
		alert("<%=LANG['error_no_dirname']%>");
		return false;
	}
	ajaxRequest("mkdir","dir="+urlEncode(newname));
}

function renameFile()
{
	if(selectedRow == null)
	{
		alert("<%=LANG['error_nofile']%>");
		return;
	}

	var f_name = selectedRow.cells[0].getAttribute("name");
	var filename = htmldecode(f_name);

	showMessagebox("<%=LANG['rename_title']%>","<br><span style='width:110px;display:-moz-inline-box;display:inline-block;'><%=LANG['rename_oldname']%>:</span><input type='text' style='width:180px' id='oldname' value='"+htmlencode(filename)+"' disabled><br><span style='width:110px;display:-moz-inline-box;display:inline-block;'><%=LANG['rename_newname']%>:</span><input type='text' style='width:180px' id='newname' tabindex='30' value='"+htmlencode(filename)+"' maxlength='128'><br><br><button id='btn_submit' type='submit' onclick='return renameFile_submit()' tabindex='20'><span><em><%=LANG['create_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();' tabindex='21'><span><em><%=LANG['create_cancel']%></em></span></button>");
	$("newname").focus();

	if(isIE)
	{
		$("btn_submit").onclick = function(){renameFile_submit();};
		$("btn_cancel").onclick = function(){top.closewindow();};
	}
}

function renameFile_submit()
{
	var oldname = htmldecode($("oldname").value);
	var newname = htmldecode($("newname").value);
	if(oldname == newname)
	{
		closewindow();
		return true;
	}
	if(newname.search(/[\\\/\<\>\:\?\"\|\*]/i) != -1)
	{
		alert("<%=LANG['error_bad_filename']%>");
		return false;
	}
	ajaxRequest("rename","oldname="+urlEncode(oldname)+"&newname="+urlEncode(newname));
	return true;
}


function checkUpload()
{
	var xmlhttpObj = isIE ? new ActiveXObject('Microsoft.XMLHTTP'):new XMLHttpRequest();
	var url = "checkupload.html?r="+Math.random();
	xmlhttpObj.open("GET",url,false);
	xmlhttpObj.send("");

	var result = xmlhttpObj.responseText;
	if(result == EXPTag)
	{
		sess_expire();
	}
	else if(result != "")
	{
		alert(result);
	}
	else
	{
		uploadFile(); 
	}
}


function uploadFile()
{
	if(getCookie("multipleupload") == "1")
	{
		$("uploadingDiv_mask").style.display = "";
		$("uploadingDiv2").style.display = "";
		var templeft = (getBrowerWidth()-500)/2;
		if(templeft < 0) templeft = 0;
		$("uploadingDiv2").style.left = templeft +"px";
		var temptop = (getBrowerHeight()-300)/2 - 30;
		if(temptop < 0) temptop = 0;
		$("uploadingDiv2").style.top = temptop +"px";

		//if(trim($("uploadingDiv2").innerHTML) == "")
		//{
			var flashInstalled = DetectFlashVer(8, 0, 0);
			if(flashInstalled)
			{
				$("uploadingDiv2").innerHTML = "<object classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000' id='myupload' width='100%' height='100%' codebase='https://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab'><param name='movie' value='FlexFileUpload.swf' /><param name='quality' value='high' /><param name='bgcolor' value='#FFFFFF' /><param name='allowScriptAccess' value='sameDomain' /><embed src='FlexFileUpload.swf' quality='high' bgcolor='#FFFFFF' width='100%' height='100%' name='myupload' align='middle' play='true' loop='false' quality='high' allowScriptAccess='sameDomain' type='application/x-shockwave-flash' pluginspage='http://www.adobe.com/go/getflashplayer'></embed></object>";
			}
			else
			{
				$("uploadingDiv2").innerHTML = "<div style='padding:3px;'>The multi-files uploader requires that you have Flash Player 8.0+ enabled on your browser. You can switch to the simple mode by the following button.<br><button id='btn_chmode' onclick='switchUploadMode(1);return false;' title='<%=LANG['button_mode2']%>'><span style='vertical-align:middle;'><em><img src='images/switch.gif' style='margin-top:3px;vertical-align : text-bottom;'></em></span></button></div>";
			}
		//}
	}
	else
	{
		var strShowTip = "";
		if(getCookie("multipleupload_tip") == "1")
		{
		}
		else
		{
			var expdate = new Date(); 
			expdate.setTime(expdate.getTime() + (86400*1000)); 
			setCookie("multipleupload_tip", "1", expdate);

			if(isIE)
			{
				strShowTip = "<div class='BubbleContainerIE'><div class='BubbleContent'><%=LANG['button_mode1']%></div><s><i></i></s></div>";
			}
			else if(isFirefox)
			{
				strShowTip = "<div class='BubbleContainerFF'><div class='BubbleContent'><%=LANG['button_mode1']%></div><s><i></i></s></div>";
			}
			else
			{
				strShowTip = "<div class='BubbleContainer'><div class='BubbleContent'><%=LANG['button_mode1']%></div><s><i></i></s></div>";
			}
		}

		showMessagebox("<%=LANG['upload_title']%>","<br><form method='post' name='uploadform' id='uploadform' onsubmit='return uploadStart();' enctype='multipart/form-data' action='uploadok.html' target='hiddenframe'><input name='filename' type='file' size='20' id='filename' tabindex='30'><br><br><br><button id='btn_submit' type='submit' tabindex='20'><span><em><%=LANG['upload_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();return false;' tabindex='21'><span><em><%=LANG['create_cancel']%></em></span></button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button id='btn_chmode' onclick='switchUploadMode(0);return false;' title='<%=LANG['button_mode1']%>' tabindex='-1'><span style='vertical-align:middle;'><em><img src='images/switch.gif' style='margin-top:3px;vertical-align: text-bottom;'></em></span></button>"+strShowTip+"</form>", cancelUpload);
		$("btn_submit").focus();

		if(isIE)
		{
			$("btn_cancel").onclick = function(){top.closewindow();return false;};
			$("btn_chmode").onclick = function(){switchUploadMode(0);return false;};
		}
	}
}

function cancelUpload()
{
	if(uploading == true)
	{
		if(confirm("<%=LANG['uploadclose_confirm']%>"))
		{
			window.location = "main.html";
			return true;
		}
		else
		{
			return false;
		}
	}
	return true;
}

function uploadStart()
{
	if(uploading == false)
	{
		if($("filename").value == "")
		{
			alert("<%=LANG['error_no_uploadfile']%>");
			return false;
		}
		else
		{
			upload_filename = "";
			var tmpname = $("filename").value;
			if(tmpname.lastIndexOf("\\") != -1)
				upload_file = tmpname.substr(tmpname.lastIndexOf("\\")+1);
			else if(tmpname.lastIndexOf("\/") != -1)
				upload_file = tmpname.substr(tmpname.lastIndexOf("\/")+1);
			else
				upload_file = tmpname;
		}

		var overwrite = false;
		var upFilename = htmlencode(upload_file);
		var listtableRows = $("listtable").tBodies[0].rows;
		for (var i=0; i < listtableRows.length; i++)
		{
			if(upFilename == listtableRows[i].cells[0].getAttribute("name"))
			{
				overwrite = true;
				break;
			}
		}
		if(overwrite == true && confirm("<%=LANG['overwrite_confirm']%>") == false)
		{
			return false;
		}

		uploading = true;
		$("uploadingDiv").style.display = "";
		$("uploadingDiv").innerHTML = "<%=LANG['upload_ready']%><img src='images/loading.gif'>";
		$("uploadingDiv").focus();

		setTimeout("idleupload()",3000);
	    d = new Date();
		start_time = d.getTime();
		last_uploadsize = 0;
		last_lefttime = -1;
		return true;
	}
	else
	{
		return false;
	}
}

function idleupload()
{
	clearInterval(_TIMER_UPLOADING);
	_TIMER_UPLOADING = setInterval("uploadRefresh()",2000);
}

function uploadEnd()
{
	try
	{
		uploading=false;
		upload_file = "";
		upload_filename = "";
		clearInterval(_TIMER_UPLOADING);
		$("uploadingDiv").style.display = "none";
		$("uploadform").reset();
		location.reload();

	}
	catch(e){}
}

function uploadEnd_ok()
{
	try
	{
		uploading=false;
		upload_file = "";
		upload_filename = "";
		clearInterval(_TIMER_UPLOADING);
		$("uploadingDiv").style.display = "none";
		$("uploadform").reset();
		

	}
	catch(e){}
}

function editFile()
{
	if(selectedRow == null)
	{
		alert("<%=LANG['error_nofile']%>");
		return;
	}

	if(selectedRow.cells[2].innerHTML == "<%=LANG['list_directory']%>")
	{
		alert("<%=LANG['error_edit']%>");
		return;
	}
	else
	{
		var f_name = selectedRow.cells[0].getAttribute("name");
		var filename = htmldecode(f_name);
		filename = urlEncodeSpecial(filename);
		var frametag = new Date().getTime();
		showMessagebox("<span title='"+f_name+"'>"+f_name.substr(0,55)+(f_name.length > 55 ? "...":"")+"</span>","<iframe src='editor.html?dir="+urlEncodeSpecial(now_dir)+"&filename="+filename+"&r="+Math.random()+"' width=720 height=520 border=0 frameborder=0 id='modify"+frametag+"'></iframe>",null,720,520);
	}
}

function downloadFile()
{
	if(selectedRow == null)
	{
		alert("<%=LANG['error_nofile']%>");
		return;
	}

	var f_name = selectedRow.cells[0].getAttribute("name");
	var f_name2 = htmldecode(f_name);
	var f_ext = getExtention(f_name2);
	var filename = urlEncodeSpecial(f_name2);
	var filesize = selectedRow.cells[0].getAttribute("fsize");

	if(f_ext == "gif" || f_ext == "png" || f_ext == "jpg" || f_ext == "jpeg" || f_ext == "bmp" )
		show_picture(filename);
	else if(f_ext == "mid" || f_ext == "wav" || f_ext == "mp3" || f_ext == "wma" || f_ext == "wmv" || f_ext == "asf" || f_ext == "avi" || f_ext == "mpg" || f_ext == "mpeg" || f_ext == "mov" )
		show_video(filename+"&UID=<%=_SESSION_ID%>",2,f_name2);
	else if(f_ext == "rm" || f_ext == "ra" || f_ext == "rmvb")
		show_video(filename+"&UID=<%=_SESSION_ID%>",1,f_name2);
	else if(f_ext == "swf")
		show_video(filename+"&UID=<%=_SESSION_ID%>",0,f_name2);
	else if(f_ext == "txt" || f_ext == "cpp" || f_ext == "c" || f_ext == "h" || f_ext == "hpp" || f_ext == "lua" || f_ext == "sh"  || f_ext == "java"  || f_ext == "xml" || f_ext == "html" || f_ext == "htm" || f_ext == "js" || f_ext == "css" || f_ext == "php" || f_ext == "jsp" || f_ext == "asp" || f_ext == "pl" || f_ext == "py")
	{
		var frametag = new Date().getTime();
		showMessagebox("<span title='"+f_name+"'>"+f_name.substr(0,55)+(f_name.length > 55 ? "...":"")+"</span>","<iframe src='editor.html?dir="+urlEncodeSpecial(now_dir)+"&filename="+filename+"&r="+Math.random()+"' width=720 height=520 border=0 frameborder=0 id='modify"+frametag+"'></iframe>",null,720,520);
	}
	else
	{
		download_url = "?download&filename="+filename+"&UID=<%=_SESSION_ID%>&r="+Math.random();
		if(isIE)
			checkDownload("checkdownload.html?filename="+filename+"&filesize="+filesize+"&r="+Math.random());
		else
			ajaxRequest("checkdownload","filename="+filename+"&filesize="+filesize+"&r="+Math.random());
	}
}

function downloadFile_ext()
{
	if(selectedRow == null)
	{
		alert("<%=LANG['error_nofile']%>");
		return;
	}

	if(selectedRow.cells[2].innerHTML == "<%=LANG['list_directory']%>")
	{
		openDirectory()
	}
	else
	{
		var f_name = selectedRow.cells[0].getAttribute("name");
		var filename = htmldecode(f_name);
		filename = urlEncodeSpecial(filename);
		var filesize = selectedRow.cells[0].getAttribute("fsize");
		download_url = "?download&filename="+filename+"&UID=<%=_SESSION_ID%>&r="+Math.random();
		if(isIE)
			checkDownload("checkdownload.html?filename="+filename+"&filesize="+filesize+"&r="+Math.random());
		else
			ajaxRequest("checkdownload","filename="+filename+"&filesize="+filesize+"&r="+Math.random());
	}
}

function checkDownload(url)
{
	var xmlhttpObj = isIE ? new ActiveXObject('Microsoft.XMLHTTP'):new XMLHttpRequest();
	xmlhttpObj.open("GET",url,false);
	xmlhttpObj.send("");

	var result = xmlhttpObj.responseText;
	if(result == EXPTag)
	{
		sess_expire();
	}
	else if(result != "")
	{
		alert(result);
	}
	else
	{
		window.open(download_url,"_self"); 
	}
}

function deleteFile(multiple)
{
	if(multiple == null || multiple == false || multiple == 0)
	{
		var checkedlist = getCheckedFilelist();
		if(checkedlist != "")
		{
			alert("<%=LANG['multifiles_tip']%>");

			if(selectedRow == null)
				return;
		}

		if(selectedRow == null)
		{
			alert("<%=LANG['error_nofile']%>");
			return;
		}

		var filestring = "<%=LANG['list_file']%>";
		var isdir = "0";
		if(selectedRow.cells[2].innerHTML == "<%=LANG['list_directory']%>")
		{
			filestring = "<%=LANG['list_directory']%>";
			isdir = "1";
		}
		var filename = htmldecode(selectedRow.cells[0].getAttribute("name"));
		if(confirm("<%=LANG['delete_confirm']%>"+filestring+" "+filename+"' ?"+(isdir=="1"?"\r\n<%=LANG['rmdir_tip']%>":"") ))
		{
			ajaxRequest("rmdir","isdir="+isdir+"&dir="+urlEncode(filename));
			selectedRow = null;
		}
	}
	else
	{
		var dirlist = getCheckedDirlist(1);
		var filelist = getCheckedDirlist(0);
		if(dirlist == "" && filelist == "")
		{
			alert("<%=LANG['no_checkbox']%>");
			return false;
		}
		else
		{
			if(confirm("<%=LANG['mdelete_confirm']%>"))
			{
				ajaxRequest("rmdirfile","dirlist="+urlEncode(dirlist)+"&filelist="+urlEncode(filelist));
				unselectAll();
			}
		}
	}
}

function cutFile(multiple)
{
	var filename = "";
	if(multiple == null || multiple == false || multiple == 0)
	{
		var checkedlist = getCheckedFilelist();
		if(checkedlist != "")
		{
			alert("<%=LANG['multifiles_tip']%>");

			if(selectedRow == null)
				return;
		}

		if(selectedRow == null)
		{
			alert("<%=LANG['error_nofile']%>");
			return;
		}

		filename = htmldecode(selectedRow.cells[0].getAttribute("name"));
	}
	else
	{
		filename = getCheckedFilelist();
		if(filename == "")
		{
			alert("<%=LANG['no_checkbox']%>");
			return false;
		}
	}
	ajaxRequest("cut","filename="+urlEncode(filename));
	selectedRow = null;
	unselectAll();
	$("pasteitem").style.display = "";
	$("pasteitem2").style.display = "";
	$("pasteitem3").style.display = "";
}

function pasteFile()
{
	ajaxRequest("paste","");
}

function changePassword()
{
	showMessagebox("<%=LANG['item_changepass']%>","<br><table id='listhead2' width='100%' border='0' cellpadding='2' cellspacing='3'><tr><td style='padding-left:20px;'><%=LANG['old_password']%>: </td><td><input type='password' id='oldpassword' style='width:160px' tabindex='28'></td></tr><tr><td style='padding-left:20px;'><%=LANG['new_password']%>: </td><td><input type='password' id='newpassword' style='width:160px' tabindex='29'><br><span style='font-size:9px;color:#777'><%=LANG['str_password_strength']%>:<img src='images/pass_strength0.gif' id='pass_strength' border='0' align='absmiddle'></span></td></tr><tr><td style='padding-left:20px;'><%=LANG['newpass_confirm']%>: </td><td><input type='password' id='newpass_confirm' style='width:160px' tabindex='30'></td><tr><td colspan=2 height=25>&nbsp;</td></tr><tr align='center'><td colspan=2><button id='btn_submit' type='submit' onclick='changePassword_submit()' tabindex='20'><span><em><%=LANG['create_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();' tabindex='21'><span><em><%=LANG['create_cancel']%></em></span></button></td></tr>",null,360,220);
	$("oldpassword").focus();

	if(isIE)
	{
		$("btn_submit").onclick = function(){changePassword_submit();};
		$("btn_cancel").onclick = function(){top.closewindow();};
	}

	$("newpassword").onkeyup = inputPassword;
	$("newpassword").onafterpaste = inputPassword;
}

function inputPassword()
{
	var nPassStrong = checkPasswordStrong($("newpassword").value);
	if(nPassStrong <= 1)
	{
		$("pass_strength").src = "images/pass_strength1.gif";
	}
	else if(nPassStrong == 2 || nPassStrong == 3)
	{
		$("pass_strength").src = "images/pass_strength2.gif";
	}
	else
	{
		$("pass_strength").src = "images/pass_strength3.gif";
	}
}

function changePassword_submit()
{
	var oldpassword = $("oldpassword").value;
	var newpassword = $("newpassword").value;
	var newpass_confirm = $("newpass_confirm").value;
	if(newpassword != newpass_confirm)
	{
		alert("<%=LANG['changepass_error']%>");
		return;
	}

	//if(checkPasswordStrong(newpassword) < 2)
	//{
	//	if(confirm("<%=LANG['str_weak_password']%>"))
	//		return;
	//}

	ajaxRequest("changepass","oldpassword="+urlEncode(oldpassword)+"&newpassword="+urlEncode(newpassword)+"&r="+Math.random() );
}

function changepass()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	alert(result);	
	top.closewindow();
}

function checkdownload_Result()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
	}
	else if(result != "")
	{
		alert(result);
	}
	else
	{
		window.open(download_url,"_self"); 
	}
}

function clientHelp()
{
	window.open("http://net.nau.edu.cn/index.php/NetDisk","_blank"); 
}

function signOut()
{
	if(confirm("<%=LANG['signout_confirm']%>"))
		window.location = "logout.html";
}

btnHover = function(){
      var buttonObj = document.body.getElementsByTagName("button");
      for (var i=0; i<buttonObj.length; i++) {
			if(buttonObj[i].className != "mybutton")
			{
				buttonObj[i].onmouseover=function(){
						this.className = "buttonhover";
				}
				buttonObj[i].onmouseout=function(){
						this.className = this.className.replace(/\bbuttonhover\b/,'');
				}
			}
      }
}
if(window.attachEvent && isIE)
	window.attachEvent("onload", btnHover);


function getLocation()
{
	if(location.href.indexOf("main.html") == -1)
		return location.href+"/main.html";
	else
		return location.href;
}

function getSessionID()
{
	return "<%=_SESSION_ID%>";
}

function getItemLabel(index)
{
	index = parseInt(index);
	var strLable = new Array('<%=LANG["upload_title"]%>','<%=LANG["thread_name"]%>','<%=LANG["thread_size"]%>','<%=LANG["thread_status"]%>',
							'<%=LANG["str_uploading"]%>','<%=LANG["str_pending"]%>','<%=LANG["upload_submit"]%>','<%=LANG["str_app_stop"]%>',
							'<%=LANG["str_browse"]%>','<%=LANG["str_clearall"]%>','<%=LANG["str_remove"]%>','<%=LANG["str_close"]%>',
							'<%=LANG["str_totalfile"]%>','<%=LANG["str_totalsize"]%>','<%=LANG["str_remaining"]%>','<%=LANG["str_complete"]%>',
							'<%=LANG["button_mode2"]%>');
	return strLable[index];
}

function closeUploadWindow()
{
	$("uploadingDiv_mask").style.display = "none";
	$("uploadingDiv2").style.display = "none";

	if(isFirefox)
	{
		goTo();
		top.closewindow();
	}
}

function checkOverwrite(filename,totalfiles)
{
	if(auto_overwrite == true)
		return "1";

	try
	{
		totalfiles = parseInt(totalfiles);
	}
	catch(e)
	{
		totalfiles = 1;
	}

	var overwrite = false;
	var upFilename = htmlencode(filename);
	var listtableRows = $("listtable").tBodies[0].rows;
	for (var i=0; i < listtableRows.length; i++)
	{
		if(upFilename == listtableRows[i].cells[0].getAttribute("name"))
		{
			overwrite = true;
			break;
		}
	}
	if(overwrite == true && confirm("<%=LANG['overwrite_confirm']%>") == false)
	{
		return "0";
	}

	if(totalfiles > 1 && overwrite == true && confirm("<%=LANG['str_auto_overwrite']%>") == true)
		auto_overwrite = true;

	return "1";
}

function checkUploadError()
{
	var httpObject = isIE ? new ActiveXObject('Microsoft.XMLHTTP'):new XMLHttpRequest();
	
	if(httpObject) 
	{
		httpObject.open("GET","uploadstat.html?r="+Math.random(),false);
		httpObject.send("");
		var result = trim(httpObject.responseText);
		if(result == "-1")
		{
			alert("<%=LANG['error_upload']%>");
			ajaxRequest("dir",'r='+Math.random());
			return "0";
		}
		else if(result == "-2")
		{
			alert("<%=LANG['error_upload']%>");
			ajaxRequest("dir",'r='+Math.random());
			return "0";
		}
		else if(result == "-3")
		{
			alert("<%=LANG['error_upload3']%>");
			ajaxRequest("dir",'r='+Math.random());
			return "0";
		}
		else if(result == "-4")
		{
			alert("<%=LANG['error_upload4']%>");
			ajaxRequest("dir",'r='+Math.random());
			return "0";
		}
		else if(result == "0")
		{
			alert("<%=LANG['session_expire']%>");
			window.location = "logout.html";
			return "0";
		}
		else
		{
			return "1";
		}
	}
}

function switchUploadMode(simpleMode)
{
	if(simpleMode == 1 || simpleMode == "1" )
	{
		$("uploadingDiv_mask").style.display = "none";
		$("uploadingDiv2").style.display = "none";
		deleteCookie("multipleupload");

		showMessagebox("<%=LANG['upload_title']%>","<br><form method='post' name='uploadform' id='uploadform' onsubmit='return uploadStart();' enctype='multipart/form-data' action='uploadok.html' target='hiddenframe'><input name='filename' type='file' size='20' id='filename' tabindex='30'><br><br><br><button id='btn_submit' type='submit' tabindex='20'><span><em><%=LANG['upload_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();return false;' tabindex='21'><span><em><%=LANG['create_cancel']%></em></span></button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button id='btn_chmode' onclick='switchUploadMode(0);return false;' title='<%=LANG['button_mode1']%>' tabindex='-1'><span style='vertical-align:middle;'><em><img src='images/switch.gif' style='margin-top:3px;vertical-align : text-bottom;'></em></span></button></form>",cancelUpload);
		$("btn_submit").focus();

		if(isIE)
		{
			$("btn_cancel").onclick = function(){top.closewindow();return false;};
			$("btn_chmode").onclick = function(){switchUploadMode(0);return false;};
		}
	}
	else
	{
		if(uploading == false)
		{
			top.closewindow();
			var expdate = new Date(); 
			expdate.setTime(expdate.getTime() + (86400*1000)); 
			setCookie("multipleupload", "1", expdate); 

			$("uploadingDiv_mask").style.display = "";
			$("uploadingDiv2").style.display = "";
			var templeft = (getBrowerWidth()-500)/2;
			if(templeft < 0) templeft = 0;
			$("uploadingDiv2").style.left = templeft +"px";
			var temptop = (getBrowerHeight()-300)/2 - 30;
			if(temptop < 0) temptop = 0;
			$("uploadingDiv2").style.top = temptop +"px";

			//if(trim($("uploadingDiv2").innerHTML) == "")
			//{
				var flashInstalled = DetectFlashVer(8, 0, 0);
				if(flashInstalled)
				{
					$("uploadingDiv2").innerHTML = "<object classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000' id='myupload' width='100%' height='100%' codebase='https://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab'><param name='movie' value='FlexFileUpload.swf' /><param name='quality' value='high' /><param name='bgcolor' value='#FFFFFF' /><param name='allowScriptAccess' value='sameDomain' /><embed src='FlexFileUpload.swf' quality='high' bgcolor='#FFFFFF' width='100%' height='100%' name='myupload' align='middle' play='true' loop='false' quality='high' allowScriptAccess='sameDomain' type='application/x-shockwave-flash' pluginspage='http://www.adobe.com/go/getflashplayer'></embed></object>";
				}
				else
				{
					$("uploadingDiv2").innerHTML = "<div style='padding:3px;'>The multi-files uploader requires that you have Flash Player 8.0+ enabled on your browser. You can switch to the simple mode by the following button.<br><button id='btn_chmode' onclick='switchUploadMode(1);return false;' title='<%=LANG['button_mode2']%>'><span style='vertical-align:middle;'><em><img src='images/switch.gif' style='margin-top:3px;vertical-align : text-bottom;'></em></span></button></div>";
				}
			//}
		}
	}

}


function download_by_applet()
{
	$("downloadDiv_mask").style.display = "";
	$("downloadDiv").style.display = "";
	var templeft = (getBrowerWidth()-560)/2;
	if(templeft < 0) templeft = 0;
	$("downloadDiv").style.left = templeft +"px";
	var temptop = (getBrowerHeight()-340)/2 - 30;
	if(temptop < 0) temptop = 0;
	$("downloadDiv").style.top = temptop +"px";

	if(isIE)
	{
		$("downloadApplet").innerHTML = "<OBJECT CLASSID = 'clsid:8ad9c840-044e-11d1-b3e9-00805f499d93' CODEBASE = 'https://java.sun.com/update/1.5.0/jinstall-1_5-windows-i586.cab#version=5,0,0,5' WIDTH = '570' HEIGHT = '50' NAME = 'WingDownloader' ALIGN = 'middle' VSPACE = '0' HSPACE = '0'><PARAM NAME = 'CODE' VALUE = 'WingDownloader.class' ><PARAM NAME = 'CODEBASE' VALUE = '.' ><PARAM NAME = 'NAME' VALUE = 'WingDownloader' ><PARAM NAME = 'ARCHIVE' VALUE = 'downloader.jar'><PARAM NAME = 'TYPE' VALUE = 'application/x-java-applet;version=1.5'><EMBED TYPE = 'application/x-java-applet;version=1.5'  CODE = 'WingDownloader.class' ARCHIVE = 'downloader.jar' CODEBASE = '.' NAME = 'downloader' WIDTH = '570' HEIGHT = '50' ALIGN = 'middle' VSPACE = '0' HSPACE = '0' pluginspage='http://java.sun.com/products/plugin/index.html#download'></EMBED></OBJECT>";
	}
	else
	{
		$("downloadApplet").innerHTML = "<applet name='WingDownloader' code='WingDownloader.class' mayscript='true' archive='downloader.jar' width='570' height='50'></applet>"
	}

    for(var x=$("AllFileList").length-1;x>=0;x--)
    {
        $("AllFileList").options[x] = null;
    }

    for(var x=$("DownloadList").length-1;x>=0;x--)
    {
        $("DownloadList").options[x] = null;
    }

	var localaddress = location.href.replace(/\#/g,"");
	for(var k=0;k<total_num;k++)
	{
		try
		{
			if($("tr_"+k).parentNode.cells[2].innerHTML != "<%=LANG['list_directory']%>")
			{
				var f_name = $("tr_"+k).getAttribute("name");
				var filename = urlEncodeSpecial(htmldecode(f_name));
				var downloadURL = localaddress + "?download&filename="+filename+"&UID=<%=_SESSION_ID%>&r="+Math.random();
				$("AllFileList").options.add(new Option(f_name,downloadURL));
			}
		}
		catch(e){}
	}

}

function closeDownloadWindow()
{
    for(var x=$("AllFileList").length-1;x>=0;x--)
    {
        $("AllFileList").options[x] = null;
    }

    for(var x=$("DownloadList").length-1;x>=0;x--)
    {
        $("DownloadList").options[x] = null;
    }
	$("downloadApplet").innerHTML = "";
	$("downloadDiv_mask").style.display = "none";
	$("downloadDiv").style.display = "none";

}

function getSavePath()
{
	return appletSavePath;
}

function setSavePath(savePath)
{
	appletSavePath = savePath;
	$("downloadSavePath").innerHTML = "&nbsp;&nbsp;<b><%=LANG['str_app_savepath']%>:</b> "+htmlencode(appletSavePath);
}

function startDownload()
{
	$("download_add").disabled = true;
	$("download_del").disabled = true;
}

function stopDownload()
{
	$("download_add").disabled = false;
	$("download_del").disabled = false;
	$("downloadTip").innerHTML = "&nbsp;";
	$("downloadProgress").innerHTML = "&nbsp;";
}

function pushDownloadFile()
{
	try
	{
		if($("DownloadList").length > 0)
		{
			for(var i=0;i<total_num;i++)
			{
				var tmpname = htmldecode($("tr_"+i).getAttribute("name"));
				if(tmpname == $("DownloadList").options[0].text)
				{
					bigfilesize = parseInt($("tr_"+i).getAttribute("fsize"));
					break;
				}
			}
			return $("DownloadList").options[0].text;
		}
		else
		{
			return "none";
		}
	}
	catch(e){}
}

function pushDownloadURL()
{
	try
	{
		if($("DownloadList").length > 0)
			return $("DownloadList").options[0].value;
		else
			return "none";
	}
	catch(e){}
}

function popDownloadFile()
{
	try
	{
		if($("DownloadList").length > 0)
			$("DownloadList").options[0] = null;
	}
	catch(e){}
}

function showDownloadProgress(downloadedSize,fileSize)
{
	try
	{
		if($("DownloadList").length > 0)
		{
			var filename = $("DownloadList").options[0].text;
			downloadedSize = parseInt(downloadedSize);
			fileSize = parseInt(fileSize);
			if(fileSize <= 0)
				fileSize = bigfilesize;
			if(downloadedSize > fileSize)
				downloadedSize = fileSize; 
			var scale = round((downloadedSize / fileSize)*100 , 0);
			$("downloadProgress").innerHTML = "<div class='progress_border'><div class='progress_bar' style='background-position:"+(100-scale)+"% 0px'>"+scale+"%</div></div>";
			$("downloadTip").innerHTML = "<%=LANG['str_app_downloading']%>: <b>"+filename.substr(0,28)+(filename.length > 28 ? "...":"")+"</b>";
		}
	}
	catch(e){}
}

function checkDownloadError(filename,filesize)
{
	filesize = parseInt(filesize);
	var url = "checkdownload.html?filename="+filename+"&filesize="+filesize+"&r="+Math.random();
	var xmlhttpObj = isIE ? new ActiveXObject('Microsoft.XMLHTTP'):new XMLHttpRequest();
	xmlhttpObj.open("GET",url,false);
	xmlhttpObj.send("");

	var result = xmlhttpObj.responseText;
	if(result == EXPTag)
	{
		sess_expire();
		return "0";
	}
	else if(result != "")
	{
		alert(result+" \n"+filename);
		return "0";
	}
	return "1";
}

function getAppletLabel()
{
	this.str_app_savepath = "<%=LANG['str_app_savepath']%>";
	this.str_app_choosedir = "<%=LANG['str_app_choosedir']%>";
	this.str_app_start = "<%=LANG['str_app_start']%>";
	this.str_app_stop = "<%=LANG['str_app_stop']%>";
	this.str_app_suspend = "<%=LANG['str_app_suspend']%>";
	this.str_app_resume = "<%=LANG['str_app_resume']%>";
	this.str_app_close = "<%=LANG['str_app_close']%>";
	this.str_app_downloading = "<%=LANG['str_app_downloading']%>";
	this.str_app_nodownloads = "<%=LANG['str_app_nodownloads']%>";
	this.str_app_nodir = "<%=LANG['str_app_nodir']%>";
}

function openSearch()
{
	var frametag = new Date().getTime();
	showMessagebox("<%=LANG['str_searchfiles']%>","<iframe src='search.html?searchin="+urlEncodeSpecial(now_dir)+"&r="+Math.random()+"' width=620 height=430 border=0 frameborder=0 id='modify"+frametag+"'></iframe>",null,620,430);
}

function checkPasswordStrong(password)
{
	var nStrong = 0;
	var bSequence = true;
	var lastCharCode = -1;
	for(var i=0; i<password.length; i++)
	{
		var charcode = password.charCodeAt(i);
		if(lastCharCode != -1 && charcode != (lastCharCode+1))
		{
			bSequence = false;
			break;
		}
		lastCharCode = charcode;
	}

	if(password.match(/[0-9]/)) nStrong++;
	if(password.match(/[A-Z]/)) nStrong++; 
	if(password.match(/[a-z]/)) nStrong++; 
	if(password.match(/[@#$%&!*)(-+=^]/)) nStrong++; 
	if(password.length >= 12) nStrong++; 
	if(password.length <= 6) nStrong--; 
	if(bSequence == true) nStrong--;

	return nStrong;
}

function menuMouseOver(obj)
{
	obj.style.color="#FFFFFF";
	obj.style.backgroundColor="#1665CB";
	obj.style.cursor="pointer"; 
}

function menuMouseOut(obj)
{
	obj.style.backgroundColor="#FFFFFF";
	obj.style.color="#000000";
}

function clickCheckbox(obj)
{
	var id = obj.getAttribute("ccid");
	$("cid_"+id).checked = obj.checked;
}


function zipFile(multiple)
{
	var filelist = "";
	if(multiple == null || multiple == false || multiple == 0)
	{
		var checkedlist = getCheckedFilelist();
		if(checkedlist != "")
		{
			alert("<%=LANG['multifiles_tip']%>");

			if(selectedRow == null)
				return;
		}

		if(selectedRow == null)
		{
			alert("<%=LANG['error_nofile']%>");
			return;
		}

		filelist = selectedRow.cells[0].getAttribute("name");
	}
	else
	{
		filelist = getCheckedFilelist();
		if(filelist == "")
		{
			alert("<%=LANG['no_checkbox']%>");
			return false;
		}
	}

	showMessagebox("<%=LANG['createzip_title']%>","<br><%=LANG['zip_filename']%>: <input type='text' id='zipfilename' style='width:150px' maxlength=60 tabindex='30'>  .zip<br><br><br><span style='line-height:120%;width:310px;'><img src='images/warning.gif' align='absmiddle'><%=LANG['zipfile_tip']%></span><br><br><input type='hidden' id='srcfilelist' value='"+htmlencode(filelist)+"'><button id='btn_submit' type='submit' onclick='zipFile_submit()' tabindex='20'><span><em><%=LANG['create_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();' tabindex='21'><span><em><%=LANG['create_cancel']%></em></span></button>",null,380,220);
	$("zipfilename").focus();

	if(isIE)
	{
		$("btn_submit").onclick = function(){zipFile_submit();};
		$("btn_cancel").onclick = function(){top.closewindow();};
	}
}

function zipFile_submit()
{
	var zipfilename = htmldecode($("zipfilename").value) + ".zip";
	if(zipfilename.search(/[\\\/\<\>\:\?\"\|\*]/i) != -1)
	{
		alert("<%=LANG['error_bad_filename']%>");
		return false;
	}
	else if(zipfilename == ".zip")
	{
		alert("<%=LANG['error_no_filename']%>");
		return false;
	}

	var listtableRows = $("listtable").tBodies[0].rows;
	for (var i=0; i < listtableRows.length; i++)
	{
		if(zipfilename == listtableRows[i].cells[0].getAttribute("name"))
		{
			alert("<%=LANG['zipfile_exist']%>");
			return false;
		}
	}

	var filelist = htmldecode($("srcfilelist").value);
	if(filelist == "")
	{
		alert("<%=LANG['no_sourcefile']%>");
		return false;
	}
	ajaxRequest("zip","zipfile="+urlEncode(zipfilename)+"&srcfiles="+urlEncode(filelist));
	selectedRow = null;
	unselectAll();
}

function unzipFile()
{
	if(selectedRow == null)
	{
		alert("<%=LANG['error_nofile']%>");
		return;
	}

	var f_name = htmldecode(selectedRow.cells[0].getAttribute("name"));
	var file_ext = getExtention(f_name);
	if(selectedRow.cells[2].innerHTML == "<%=LANG['list_directory']%>" || file_ext != "zip")
	{
		alert("<%=LANG['no_zipfile']%>");
		return;
	}

	if(confirm("<%=LANG['unzipfile_tip']%>"))
		ajaxRequest("unzip","zipfile="+urlEncode(f_name));
}

function zip()
{
	$("waitingdiv2").style.display = "none";
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	if(result == "")
		alert("<%=LANG['zipfile_success']%>");
	else
		alert("<%=LANG['zipfile_failed']%>"+result);
	top.closewindow();
	ajaxRequest("dir",'r='+Math.random());
}

function unzip()
{
	$("waitingdiv2").style.display = "none";
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	if(result == "")
	{
		alert("<%=LANG['zipfile_success']%>");
	}
	else
	{
		alert("<%=LANG['zipfile_failed']%>"+result);
	}
	ajaxRequest("dir",'r='+Math.random());
}

function rmdirfile()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}
	alert(result);	
	ajaxRequest("dir",'r='+Math.random());
}

function getCheckedDirlist(dir)
{ 
	var filelist = "";
	var checkboxs = document.getElementsByTagName("input");
	for(var i=0;i<checkboxs.length;i++)
	{
		if(checkboxs[i].type == "checkbox" && checkboxs[i].checked == true)
		{
			try
			{
				if(checkboxs[i].getAttribute("flag") == "list")
				{
					var cid = checkboxs[i].getAttribute("cid");
					if(dir == 1 && $("tr_"+cid).parentNode.cells[2].innerHTML == "<%=LANG['list_directory']%>")
					{
						if(filelist != "") filelist += "||";
						filelist += htmldecode($("tr_"+cid).getAttribute("name"));
					}
					if(dir == 0 && $("tr_"+cid).parentNode.cells[2].innerHTML != "<%=LANG['list_directory']%>")
					{
						if(filelist != "") filelist += "||";
						filelist += htmldecode($("tr_"+cid).getAttribute("name"));
					}
				}
			}
			catch (e){}
		}
	}
	return filelist;
}

function newText()
{
	showMessagebox("<%=LANG['newtext_title']%>","<br><%=LANG['text_filename']%>: <input type='text' id='newfilename' style='width:150px' maxlength='128' tabindex='30'> .txt<br><br><br><button id='btn_submit' type='submit' onclick='newText_submit()' tabindex='20'><span><em><%=LANG['create_submit']%></em></span></button>&nbsp;&nbsp;&nbsp;<button id='btn_cancel' onclick='top.closewindow();' tabindex='21'><span><em><%=LANG['create_cancel']%></em></span></button>",null,330,180);
	$("newfilename").focus();

	if(isIE)
	{
		$("btn_submit").onclick = function(){newText_submit();};
		$("btn_cancel").onclick = function(){top.closewindow();};
	}
}

function newText_submit()
{
	var newname = htmldecode($("newfilename").value) + ".txt";
	if(newname.search(/[\\\/\<\>\:\?\"\|\*]/i) != -1)
	{
		alert("<%=LANG['error_bad_filename']%>");
		return false;
	}
	else if(newname == ".txt")
	{
		alert("<%=LANG['error_no_filename']%>");
		return false;
	}
	txt_filename = newname;
	ajaxRequest("mkfile","filename="+urlEncode(newname));
}

function mkfile()
{
	var result = trim(xmlhttp.responseText);
	if(result == EXPTag)
	{
		sess_expire();
		return;
	}

	if(result != "")
	{
		alert(result);
	}
	else
	{
		top.closewindow();
		ajaxRequest("dir",'r='+Math.random());

		var f_name = htmlencode(txt_filename);
		var filename = urlEncodeSpecial(txt_filename);
		var frametag = new Date().getTime();
		showMessagebox("<span title='"+f_name+"'>"+f_name.substr(0,55)+(f_name.length > 55 ? "...":"")+"</span>","<iframe src='editor.html?dir="+urlEncodeSpecial(now_dir)+"&filename="+filename+"&r="+Math.random()+"' width=720 height=520 border=0 frameborder=0 id='modify"+frametag+"'></iframe>",null,720,520);
	}
}

function SetLastField(field)
{
	if(last_field == field)
	{
		if(reverse_sort == false)
			reverse_sort = true;
		else
			reverse_sort = false;
	}
	else
	{
		reverse_sort = false;
	}
	last_field = field;
}
</script>
<body style="background:#DAE9FC;margin:0px;padding:0px;">

<div style="display:none">
<img src='images/waiting.gif'>
<img src='images/progress_border.gif'>
<img src='images/progress_bar.gif'>
<img src='images/loading.gif'>
<img src='images/loading2.gif'>
</div>

<div id="waitingdiv" style="position:absolute; z-index:1000; top:0px; left:0px; width:100%; height:100%; background:#777; filter:alpha(opacity=60); opacity:0.60; display:none;" align="center">
<div style="position:absolute; top:20%; left:40%; width:300px; height:100px;"><img src="images/loading2.gif" border="0">
<H2><b><%=LANG["update_tip"]%></b></H2></div></div>

<div id="waitingdiv2" style="position:absolute; z-index:999; top:0px; left:0px; width:100%; height:100%; background:#999; filter:alpha(opacity=60); opacity:0.60; display:none;" align="center">
<div style="position:absolute; top:20%; left:25%; width:550px; height:150px; ><br><img src="images/loading2.gif" border="0">
<H2><b><%=LANG["process_tip"]%></b></H2></div></div>


<div id="cancelupload_div" style="position:absolute; z-index:200; top:0px; left:0px; width:100%; height:100%; background:#777; filter:alpha(opacity=60); opacity:0.60; display:none;" align="center">
<div style="position:absolute; top:20%; left:40%; width:350px; height:100px;"><img src="images/loading2.gif" border="0">
<H2><b><%=LANG["cancelupload_tip"]%></b></H2></div></div>


<div id="picturediv" style="position:absolute; z-index:102; top:0px;left:0px;z-index:101;width:100%;height:100%;background-color: #000;filter:alpha(opacity=80); opacity:0.80; display:none;"></div>
<div id="picturediv2" style="position:absolute; z-index:103; width:100%; top:0px; left:0px; text-align:center; display:none; overflow:auto;">
<div id="imgloading" style="visibility:hidden;"><img src="images/loading3.gif" border="0"></div>
<button onclick='pre_picture();'><span><em><%=LANG["button_prepicture"]%></em></span></button>
<button onclick='close_picture();'><span><em><%=LANG["button_closepicture"]%></em></span></button>
<button onclick='down_picture();'><span><em><%=LANG["button_downpicture"]%></em></span></button>
<button onclick='zoom(20);'><span><em><%=LANG["button_zoomin"]%></em></span></button>
<button onclick='zoom(-20);'><span><em><%=LANG["button_zoomout"]%></em></span></button>
<button onclick='resize_picture(false);'><span><em><%=LANG["button_resetpicture"]%></em></span></button>
<button onclick='resize_picture(true);'><span><em><%=LANG["button_fullsize"]%></em></span></button>
<button id="pptbutton" onClick="ppt_start(true);"><span><em><%=LANG["button_startppt"]%></em></span></button>
<button onclick='next_picture();'><span><em><%=LANG["button_nextpicture"]%></em></span></button>
<br><span id="picture_title" style='font-size:15pt;color:#FFF;font-weight:bold;'></span><br>
<img id="picture" src="images/loading2.gif" border="0" align="absmiddle"><br><br><br><br>
</div>


<div id="videodiv" style="position:absolute; z-index:104; top:0px;left:0px;z-index:101;width:100%;height:100%;background-color: #000;filter:alpha(opacity=80); opacity:0.80; display:none;"></div>
<div id="videodiv2" style="position:absolute; z-index:105; width:100%; top:20px; left:0px; text-align:center; display:none;">
<div id="videodiv3"></div><br>
<button onclick='close_video();'><span><em><%=LANG["button_closemedia"]%></em></span></button>&nbsp;
<button onclick='show_videolist();' id="videolist_btn"><span><em><%=LANG["button_showmedia"]%></em></span></button>
<div id="videolist_div" style="position:absolute; visibility:hidden; text-align:left; background-color:#FFF; border:1px solid #CCC; width:240px; height:120px; padding:2px; overflow-y:auto;">
</div>
</div>


<div id="uploadingDiv" style="position:absolute; width:340px; height:120px; left:100px top:100px; padding:20px; line-height:20px; background:#FFF; z-index:90; display:none; border:1px solid #999;">
</div>



<div id="uploadingDiv_mask" style="position:absolute; z-index:1000; top:0px; left:0px; width:100%; height:3000px; background:#777; filter:alpha(opacity=60); opacity:0.60; display:none;" align="center">
</div>

<div id="uploadingDiv2" style="position:absolute; width:500px; height:300px; padding:0px; margin:0px; line-height:20px; background:#FFF; z-index:1002; display:none; "></div>


<div id="downloadDiv_mask" style="position:absolute; z-index:1003; top:0px; left:0px; width:100%; height:3000px; background:#777; filter:alpha(opacity=60); opacity:0.60; display:none;" align="center">
</div>

<div id="downloadDiv" style="position:absolute; width:580px; height:360px; padding:0px; margin:0px; line-height:20px; background:#FFF; z-index:1004; border: 1px solid #666; display:none; ">
<table width="100%" border="0" cellpadding="2" cellspacing="0" align="center">
<tr style="padding:0px;"><td colspan="2" height="28" style="background:url(images/graybg.gif) repeat-x; border-bottom: 1px solid #999;">&nbsp;&nbsp;<b><%=LANG["str_app_batchdown"]%></b></td><td align="right" style="background:url(images/graybg.gif) repeat-x; border-bottom: 1px solid #999;"><img src="images/close_gray.gif" title="close" onClick="closeDownloadWindow();">&nbsp;</td></tr>
<tr align="center"><td style="padding-top:10px;"><%=LANG["str_app_currentfiles"]%></td><td>&nbsp;</td><td style="padding-top:10px;"><%=LANG["str_app_queuefiles"]%></td></tr>
<tr><td>
<select id="AllFileList" name="AllFileList" multiple="true" style="width:220px;height:190px;"></select></td>
<td>
<button id="download_add" onClick="addItem(AllFileList,DownloadList)" style="width:108px;"><span><em><%=LANG["str_app_add"]%></em></span></button>
<br><br>
<button id="download_del" onClick="delItem(DownloadList)" style="width:108px;"><span><em><%=LANG["str_app_remove"]%></em></span></button>
</td>
<td><select id="DownloadList" name="DownloadList" multiple="true" style="width:220px;height:190px;"></select></td>
</tr>
<tr><td colspan="3" id="downloadSavePath">&nbsp;&nbsp;<b><%=LANG["str_app_savepath"]%>:</b> <%=LANG["str_app_notspecified"]%></td></tr>
<tr><td colspan="2" id="downloadTip" align="right">&nbsp;</td><td id="downloadProgress">&nbsp;</td></tr>
<tr><td colspan="3" id="downloadApplet"></td></tr>
</table>
</div>


<div id="menu_div" style="position:absolute; visibility:hidden; background-color:#FFF; width:178px;" onClick="return false;">
	<div class="menu_out">
	<div class="menu_in">
	<ul>
    <li style="margin-top:0px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="downloadFile_ext();"><img src="images/open.gif">&nbsp;&nbsp;<%=LANG["item_download"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="showDownloadUrl();"><img src="images/geturl.gif">&nbsp;&nbsp;<%=LANG["item_geturl"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="editFile();"><img src="images/edit.gif">&nbsp;&nbsp;<%=LANG["item_edit"]%></li>
    <li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="deleteFile(0);"><img src="images/delete.gif">&nbsp;&nbsp;<%=LANG["item_delete"]%></li>
    <li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="renameFile();"><img src="images/rename.gif">&nbsp;&nbsp;<%=LANG["item_rename"]%></li>
    <li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="zipFile(0);"><img src="images/compress.gif">&nbsp;&nbsp;<%=LANG["item_zip"]%></li>
    <li id="unzipitem" style="margin-top:4px;display:none;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="unzipFile();"><img src="images/uncompress.gif">&nbsp;&nbsp;<%=LANG["item_unzip"]%></li>
    <li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="cutFile(0);"><img src="images/cut.gif">&nbsp;&nbsp;<%=LANG["item_cut"]%></li>
	<li id="pasteitem" style="margin-top:4px;display:none;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="pasteFile();"><img src="images/paste.gif">&nbsp;&nbsp;<%=LANG["item_paste"]%></li>
	<%
	for _,val in pairs(_SERVER) do
		if (val.need_selectfile ~= nil and val.need_selectfile == true and val.extbutton_name ~= nil and val.extbutton_func ~= nil) or (val.singlefile ~= nil and val.singlefile == true) then
			local icon_path = "images/extbutton.gif"
			if val.extbutton_icon ~= nil then
				icon_path = val.extbutton_icon
			end			
			print("<li style='margin-top:4px;' onmouseover='menuMouseOver(this)' onmouseout='menuMouseOut(this)' onclick='"..val.extbutton_func.."'><img src='"..icon_path.."' width='16' height='16'>&nbsp;&nbsp;"..val.extbutton_name.."</li>")
		end
	end
	%>
	</ul>
	</div>
	</div>
</div>

<div id="menu_div2" style="position:absolute; visibility:hidden; background-color:#FFF; width:158px;" onClick="return false;">
	<div class="menu_out">
	<div class="menu_in">
	<ul>
    <li style="margin-top:0px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="checkUpload();"><img src="images/upload.gif">&nbsp;&nbsp;<%=LANG["item_upload"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="createFolder();"><img src="images/newdir.gif">&nbsp;&nbsp;<%=LANG["item_mkdir"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="newText();"><img src="images/newtxt.gif">&nbsp;&nbsp;<%=LANG["item_newtxt"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="goTo();"><img src="images/goto.gif">&nbsp;&nbsp;<%=LANG["item_goto"]%></li>
	<li id="pasteitem2" style="margin-top:4px;display:none;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="pasteFile();"><img src="images/paste.gif">&nbsp;&nbsp;<%=LANG["item_paste"]%></li>
	<%
	for _,val in pairs(_SERVER) do
		if val.need_selectfile ~= nil and val.need_selectfile == false and val.extbutton_name ~= nil and val.extbutton_func ~= nil then
			local icon_path = "images/extbutton.gif"
			if val.extbutton_icon ~= nil then
				icon_path = val.extbutton_icon
			end
			print("<li style='margin-top:4px;' onmouseover='menuMouseOver(this)' onmouseout='menuMouseOut(this)' onclick='"..val.extbutton_func.."'><img src='"..icon_path.."' width='16' height='16'>&nbsp;&nbsp;"..val.extbutton_name.."</li>")
		end
	end
	%>
	</ul>
	</div>
	</div>
</div>


<div id="action_div" style="position:absolute; visibility:hidden; background-color:#FFF; width:178px; top:108px; left:378px;" onClick="return false;">
	<div class="menu_out">
	<div class="menu_in">
	<ul>
    <li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="cutFile(0);"><img src="images/cut.gif">&nbsp;&nbsp;<%=LANG["item_cut"]%></li>
	<li id="pasteitem3" style="margin-top:4px;display:none;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="pasteFile();"><img src="images/paste.gif">&nbsp;&nbsp;<%=LANG["item_paste"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="goTo();"><img src="images/goto.gif">&nbsp;&nbsp;<%=LANG["item_goto"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="renameFile();"><img src="images/rename.gif">&nbsp;&nbsp;<%=LANG["item_rename"]%></li>

	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="showDownloadUrl();"><img src="images/geturl.gif">&nbsp;&nbsp;<%=LANG["item_geturl"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="editFile();"><img src="images/edit.gif">&nbsp;&nbsp;<%=LANG["item_edit"]%></li>
	<li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="newText();"><img src="images/newtxt.gif">&nbsp;&nbsp;<%=LANG["item_newtxt"]%></li>
    <li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="zipFile(0);"><img src="images/compress.gif">&nbsp;&nbsp;<%=LANG["item_zip"]%></li>
    <li style="margin-top:4px;" onMouseOver="menuMouseOver(this)" onMouseOut="menuMouseOut(this)" onClick="unzipFile();"><img src="images/uncompress.gif">&nbsp;&nbsp;<%=LANG["item_unzip"]%></li>
	<!--<li style="margin-top:4px;" onmouseover="menuMouseOver(this)" onmouseout="menuMouseOut(this)" onclick="download_by_applet();"><img src="images/batchdownload.gif">&nbsp;&nbsp;<%=LANG["str_app_batchdown"]%></li>-->
	<%
	for _,val in pairs(_SERVER) do
		if val.extbutton_name ~= nil and val.extbutton_func ~= nil then
			local icon_path = "images/extbutton.gif"
			if val.extbutton_icon ~= nil then
				icon_path = val.extbutton_icon
			end
			print("<li style='margin-top:4px;' onmouseover='menuMouseOver(this)' onmouseout='menuMouseOut(this)' onclick='"..val.extbutton_func.."'><img src='"..icon_path.."' width='16' height='16'>&nbsp;&nbsp;"..val.extbutton_name.."</li>")
		end
	end
	%>
	</ul>
	</div>
	</div>
</div>


<%
for _,val in pairs(_SERVER) do
	if val.exthtml ~= nil then
		print(val.exthtml)
	end
end
%>

<div id="main_interface">
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0" align="center">
  <tr>
    <td height="100%" style="padding:5px;"><table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
	<tr> 
	  <td height="100%" valign="top" bgcolor="#FFFFFF">
	  <table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
		  <tr> 
			<td height="66" background="images/top_bg.gif"> 
			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr> 
				  <td width="13"><img src="images/coner_left.gif" width="13" height="66"></td>
				  <td height="66" valign="bottom" style="background:url(images/bg.jpg) no-repeat right bottom;">
					<table width="100%" border="0" cellspacing="0" cellpadding="0">
					  <tr>
						<td width="303" id="main_logo_td"><img src="images/<%=c_GetDomainSmallLogo()%>" width="303" height="55"></td>
						<td align="right">
						<table border="0" cellspacing="0" cellpadding="0">
							<tr> 
							<%
							if nType >= 5 then
								print("<td style='color:#000;font-weight:bold;'>(UNREGISTERED COPY)</td><td width='20'>&nbsp;</td>")
							end
							%>
							  <td>[<%=LANG["welcome"]%>, <b><%=_SESSION["username"]%></b>]</td>
							  <td width="20">&nbsp;</td>
							  <td id="diskquota">&nbsp;</td>
							  <td width="20">&nbsp;</td>
							  <td><input type="image" src="images/ico_help.gif" class="cur" onClick="clientHelp();" title="<%=LANG["item_help"]%>" tabindex="-1"></td>
							  <td style="color:#FFF; cursor:pointer;" onClick="clientHelp();"><%=LANG["item_help"]%></td>
							  <% if enable_changepass == true then %>
							  <td width="15">&nbsp;</td>
							  <td><input type="image" src="images/ico_pass.gif" class="cur" onClick="changePassword();" title="<%=LANG["item_changepass"]%>" tabindex="8"></td>
							  <td style="color:#FFF; cursor:pointer;" onClick="changePassword();"><%=LANG["item_changepass"]%></td>
							  <% end %>
							  <td width="15">&nbsp;</td>
							  <td><input type="image" src="images/ico_quit.gif" class="cur" onClick="signOut();" title="<%=LANG["item_logout"]%>" tabindex="9"></td>
							  <td style="color:#FFF; cursor:pointer;" onClick="signOut();"><%=LANG["item_logout"]%></td>
							  <td width="10">&nbsp;</td>
							</tr>
						  </table>
						</td>
					  </tr>
					</table></td>
				<td width="13"><img src="images/coner_right.gif" width="13" height="66"></td>
			</tr>
		</table></td>
	</tr>
	<tr> 
	<td height="100%"> 
	<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
		<tr> 
		<td width="13" style="background:url(images/left.gif) repeat-y;"><div style="width:13px;"></div></td>
		<td id="viewspace" bgcolor="#FFFFFF" valign="top" style="height:500px; padding-top:3px;"> 


		<div style="width:100%; padding-top:2px; overflow-x:hidden;">
			<table width="100%" border="0" cellpadding="0" cellspacing="0">
			<tr valign="top"><td width="518">
			<input type="image" src="images/icon_back.gif" title="<%=LANG["item_goup"]%>" onClick="goUp()" class="cur" tabindex="1" id="first_button"> &nbsp;<input type="image" src="images/icon_home.gif" title="<%=LANG["item_gohome"]%>" onClick="goHome()" class="cur" tabindex="2"> &nbsp;<input type="image" src="images/icon_refresh.gif" title="<%=LANG["item_refresh"]%>" onClick="Refresh()" class="cur" tabindex="3"> &nbsp;<input type="image" src="images/icon_upload.gif" title="<%=LANG["item_upload"]%>" onClick="checkUpload()" class="cur" tabindex="4"> &nbsp;<input type="image" src="images/icon_download.gif" title="<%=LANG["item_download"]%>" onClick="downloadFile_ext()" class="cur" tabindex="5"> &nbsp;<input type="image" src="images/icon_delete.gif" title="<%=LANG["item_delete"]%>" onClick="deleteFile(0)" class="cur" tabindex="6"> &nbsp;<input type="image" src="images/icon_newdir.gif" title="<%=LANG["item_mkdir"]%>" onClick="createFolder()" class="cur" tabindex="7"> &nbsp;<input type="image" src="images/icon_search.gif" title="<%=LANG["str_search"]%>" onClick="openSearch()" class="cur" tabindex="-1"> &nbsp;<input type="image" src="images/icon_thumb.gif" title="<%=LANG["item_change_thumb"]%>" onClick="change_viewmode(true)" class="cur" id="thumbmode" tabindex="-1" /><input type="image" src="images/icon_list.gif" title="<%=LANG["item_change_list"]%>" onClick="change_viewmode(false)" class="cur" style="display:none;" id="listmode" tabindex="-1" />&nbsp;<button class="mybutton" style="margin-top:6px;" onClick="clickMore();" title="<%=LANG["str_more_actions"]%>" id="action_btn" tabIndex="-1"><span style="vertical-align:middle;"><em><img src="images/plusicon.gif" align="absmiddle">&nbsp;<%=LANG["str_more_actions"]%></em></span></button></td>
			<td align="right" style="padding-top:6px; ">
			<b><%=LANG["multifiles_action"]%>:</b>
			&nbsp;<button class="mybutton" onClick="zipFile(1);" title="<%=LANG["item_mzip"]%>" id="mzip_btn" tabIndex="-1"><span style="vertical-align:middle;"><em><img src="images/compress.gif" align="absmiddle">&nbsp;<%=LANG["item_mzip"]%></em></span></button>&nbsp;<button class="mybutton" onClick="deleteFile(1);" title="<%=LANG["item_mdelete"]%>" id="mdelete_btn" tabIndex="-1"><span style="vertical-align:middle;"><em><img src="images/delete.gif" align="absmiddle">&nbsp;<%=LANG["item_mdelete"]%></em></span></button>&nbsp;<button class="mybutton" onClick="cutFile(1);" title="<%=LANG["item_mcut"]%>" id="mcut_btn" tabIndex="-1"><span style="vertical-align:middle;"><em><img src="images/cut.gif" align="absmiddle">&nbsp;<%=LANG["item_mcut"]%></em></span></button>
			</td></tr>
			<tr><td width="430" height="20">&nbsp;&nbsp;<b><%=LANG["str_chkbox_select"]%>:</b> <span onClick="selectAll();" class="cur"><%=LANG["str_chkbox_all"]%></span>, <span onClick="unselectAll();" class="cur"><%=LANG["str_chkbox_none"]%></span></td>
			<td align="right"><div id="statbar"></div></td></tr>
			</table>

			<table id="listhead" width="100%" border="0" cellpadding="0" cellspacing="0" style="table-layout:fixed;">
			<tr>
			<td width="530" onMouseOver="className='listhead2';" onMouseOut="className='listhead';" class="listhead" onMouseDown="sortTable(this,'listtable', 0, 'filename');SetLastField(0);showthumb();"><div class="resizeblock" onMouseDown="dragHead(this);">&nbsp;</div><%=LANG["thread_name"]%></td>
			<td width="120" onMouseOver="className='listhead2';" onMouseOut="className='listhead';" class="listhead" onMouseDown="sortTable(this,'listtable', 1, 'size');SetLastField(1);showthumb();"><div class="resizeblock" onMouseDown="dragHead(this);">&nbsp;</div><%=LANG["thread_size"]%></td>
			<td width="150" onMouseOver="className='listhead2';" onMouseOut="className='listhead';" class="listhead" onMouseDown="sortTable(this,'listtable', 2);SetLastField(2);showthumb();"><div class="resizeblock" onMouseDown="dragHead(this);">&nbsp;</div><%=LANG["thread_type"]%></td>
			<td width="180" onMouseOver="className='listhead2';" onMouseOut="className='listhead';" class="listhead" onMouseDown="sortTable(this,'listtable', 3);SetLastField(3);showthumb();"><div class="resizeblock" onMouseDown="dragHead(this);">&nbsp;</div><%=LANG["thread_modify"]%></td>
			<td id="blanktd" class="listhead"></td>
			</tr>
			</table>
		</div>


		<div id="listview_div" style="width:100%; height: 85%; overflow:auto; overflow-x:hidden;">
			<table id="listtable" width="100%" border="0" cellpadding="0" cellspacing="0" style="table-layout:fixed;">
			<thead><tr height="0">
			<td width="530"></td>
			<td width="120"></td>
			<td width="150"></td>
			<td width="180"></td>
			<td></td>
			</tr></thead>
			<tbody id="maintable"></tbody>
			</table>
		</div>


		<div id="thumbview_div" style="width:100%; height: 85%; overflow:auto; overflow-x:hidden; display:none;">
			<table width="100%" border="0" cellpadding="0" cellspacing="0" border="0">
			<tbody id="thumbtable"></tbody>
			</table>
		<div>


		</td>
	  <td width="13" style="background:url(images/right.gif) repeat-y;"><div style="width:13px;"></div></td>
	</tr>
  </table></td>
</tr>
</table></td>
</tr>
<tr>
  <td height="12" background="images/bottom_bg.gif" bgcolor="#00CC33"><table width="100%" border="0" cellspacing="0" cellpadding="0">
	  <tr> 
		<td width="13" valign="top"><img src="images/coner_left1.gif" width="13" height="12"></td>
		<td width="100%" valign="top"></td>
		<td width="13" valign="top"><img src="images/coner_right1.gif" width="13" height="12"></td>
	  </tr>
	</table></td>
</tr>
</table>
      
  </td>
  </tr>
	<tr> 
	<td align="center">
	  <a href="http://www.wftpserver.com/" target="_blank"><br>
	  Powered by &amp;WingFTP Server</a></td>
	</tr>
</table>
</div>

<iframe name='hiddenframe' id='hiddenframe' src='empty.html' style='display:none'></iframe>
</body>
</html>
<script>
<% if _GET["redir"] ~= nil then %>
	ajaxRequest("chdir","dir="+urlEncode("<%=_GET['redir']%>"));
<% end %>

ajaxRequest("dir","r="+Math.random());

_TIMER_KEEPLIVE = setInterval("keeplive()",1000*300);


document.oncontextmenu=function(){
	var evt = getEvent();
	var element = evt.srcElement || evt.target;
	if((element.tagName =="INPUT" || element.tagName == "TEXTAREA"))
	{
		return true;
	}
	else
	{
		if((top.__zIndex != null && top.__zIndex > 100) || $("picturediv").style.display == "" || $("videodiv").style.display == "" || $("uploadingDiv_mask").style.display == "" || $("downloadDiv_mask").style.display == "")
		{
		}
		else
		{
			if($("menu_div").style.visibility == "hidden" && $("menu_div2").style.visibility == "hidden")
			{
				var evt = getEvent();
				moreaction_show = false;
				$("action_div").style.visibility = "hidden";
				$("menu_div").style.visibility = "hidden";
				$("menu_div2").style.visibility = ""; 
				$("menu_div2").style.top = evt.clientY; 
				$("menu_div2").style.left = evt.clientX; 
			}
		}
		return false;
	}
}

document.body.onclick=function(){
	var evt = getEvent();
	var element = evt.srcElement || evt.target;
	$("menu_div").style.visibility = "hidden";
	$("menu_div2").style.visibility = "hidden";

	if($("action_div").style.visibility == "" || $("action_div").style.visibility == "visible")
	{
		if(element.id != "action_btn" && moreaction_show == true)
		{
			clickMore();
		}
	}

	if($("videolist_div").style.visibility == "" || $("videolist_div").style.visibility == "visible")
	{
		if(element.id != "videolist_btn" && videolist_show == true)
		{
			close_videolist();
		}
	}

}

if(isOpera)
	document.onkeypress = myKeyDown;
else
	document.onkeydown = myKeyDown;


if(isFirefox)
	$("viewspace").style.height = ((window.screen.height-270) > 500 ? (window.screen.height-270) : 500) + "px";


<%
for _,val in pairs(_SERVER) do
	if val.extjs ~= nil then
		print(val.extjs)
	end
end
%>

</script>

<% 
else
	print("<meta http-equiv='Content-Type' content='text/html; charset=utf-8'>")
	print("<script>top.location='login.html';</script>")
end 
%>